<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>codezm 的个人博客</title>
  
  
  <link href="https://codezm.github.io/atom.xml" rel="self"/>
  
  <link href="https://codezm.github.io/"/>
  <updated>2025-12-01T08:02:38.163Z</updated>
  <id>https://codezm.github.io/</id>
  
  <author>
    <name>codezm</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>harbor-upgrade-from-v1.8.2-to-v2.14.1</title>
    <link href="https://codezm.github.io/posts/harbor/4ce8794f.html"/>
    <id>https://codezm.github.io/posts/harbor/4ce8794f.html</id>
    <published>2025-11-27T09:26:24.000Z</published>
    <updated>2025-12-01T08:02:38.163Z</updated>
    
    <content type="html"><![CDATA[<p>今天将群晖 NAS 上的 harbor 迁移到绿联 NAS 上，发现我一直用的 harbor 版本还是 <code>v1.8.2</code>，最新版已经是 <code>v2.14.1</code>。毕竟要做数据迁移，不如顺便把 harbor 版本也升级到最新版本。</p><p>如果是 <code>v1.8.2</code> 升级到 <code>v1.9.0</code> 还好说，直接用官方的 <code>prepare</code> 工具升级就完了，但是我这跨越的版本太大了，我的迁移思路是通过 harbor 自带的 <code>复制管理</code> 功功能来同步仓库的所用 docker 镜像，连打包 <code>harbor</code> 数据都省了。</p><a id="more"></a><h2 id="具体流程"><a href="#具体流程" class="headerlink" title="具体流程"></a>具体流程</h2><h3 id="1-备份-Synology-设备上的-harbor-所有数据：registry、数据库等"><a href="#1-备份-Synology-设备上的-harbor-所有数据：registry、数据库等" class="headerlink" title="1.备份 Synology 设备上的 harbor 所有数据：registry、数据库等"></a>1.备份 Synology 设备上的 harbor 所有数据：registry、数据库等</h3><blockquote><p>这一步可以不用做，因为我是直接把挂载在群晖上的硬盘挂载到了绿联上，需要找一台 centos 重启启动 v1.8.2 版本的 harbor。</p></blockquote><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar cvf data.tar /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找一台 centos 虚拟机</span></span><br><span class="line"><span class="comment"># 还原 v1.8.2 版本的 harbor</span></span><br><span class="line">wget -c https://github.com/goharbor/harbor/releases/download/v1.8.2/harbor-online-installer-v1.8.2.tgz</span><br><span class="line">tar zxf harbor-online-installer-v2.14.1.tgz</span><br><span class="line">tar xvf data.tar -C /data</span><br><span class="line"><span class="built_in">cd</span> harbor</span><br><span class="line"><span class="comment"># 配置 data_volume 指向 /data</span></span><br><span class="line">vim harbor.yml</span><br><span class="line"></span><br><span class="line">./install.sh</span><br></pre></td></tr></tbody></table></figure><h3 id="2-在绿联NAS-设备上下载并启动最新版-harbor"><a href="#2-在绿联NAS-设备上下载并启动最新版-harbor" class="headerlink" title="2. 在绿联NAS 设备上下载并启动最新版 harbor"></a>2. 在绿联NAS 设备上下载并启动最新版 harbor</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://github.com/goharbor/harbor/releases/download/v2.14.1/harbor-online-installer-v2.14.1.tgz</span><br><span class="line">tar zxf harbor-online-installer-v2.14.1.tgz</span><br><span class="line"><span class="built_in">cd</span> harbor</span><br><span class="line">cp harbor.yml.tmpl harbor.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 个性化配置 harbor.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装最新版 harbor</span></span><br><span class="line">./install.sh</span><br></pre></td></tr></tbody></table></figure><h3 id="3-浏览器登录绿联NAS上的-harbor"><a href="#3-浏览器登录绿联NAS上的-harbor" class="headerlink" title="3. 浏览器登录绿联NAS上的 harbor"></a>3. 浏览器登录绿联NAS上的 harbor</h3><h4 id="3-1-新建目标"><a href="#3-1-新建目标" class="headerlink" title="3.1 新建目标"></a>3.1 新建目标</h4><p><code>系统管理</code>、<code>仓库管理</code>、<code>新建目标</code></p><blockquote><p>注意这里的访问ID和访问密码就是旧版 harbor 的登录账号及密码，配置上之后可以通过私有镜像。</p></blockquote><img data-src="/posts/harbor/4ce8794f/image-20251127115017727.png?400" alt="image-20251127115017727" style="width:400px;" width="400"><h4 id="3-2-新建规则"><a href="#3-2-新建规则" class="headerlink" title="3.2 新建规则"></a>3.2 新建规则</h4><p><code>系统管理</code>、<code>复制管理</code>、<code>新建规则</code></p><img data-src="/posts/harbor/4ce8794f/Sync-harbor.jpg" alt="Sync-harbor" style="width:400px;" width="400">#### 3.3 复制<blockquote><p>选中要执行的规则后，点击复制按钮，等待任务执行完成即可。</p></blockquote><img data-src="/posts/harbor/4ce8794f/image-20251127123925283.png" alt="image-20251127123925283">]]></content>
    
    
    <summary type="html">&lt;p&gt;今天将群晖 NAS 上的 harbor 迁移到绿联 NAS 上，发现我一直用的 harbor 版本还是 &lt;code&gt;v1.8.2&lt;/code&gt;，最新版已经是 &lt;code&gt;v2.14.1&lt;/code&gt;。毕竟要做数据迁移，不如顺便把 harbor 版本也升级到最新版本。&lt;/p&gt;
&lt;p&gt;如果是 &lt;code&gt;v1.8.2&lt;/code&gt; 升级到 &lt;code&gt;v1.9.0&lt;/code&gt; 还好说，直接用官方的 &lt;code&gt;prepare&lt;/code&gt; 工具升级就完了，但是我这跨越的版本太大了，我的迁移思路是通过 harbor 自带的 &lt;code&gt;复制管理&lt;/code&gt; 功功能来同步仓库的所用 docker 镜像，连打包 &lt;code&gt;harbor&lt;/code&gt; 数据都省了。&lt;/p&gt;</summary>
    
    
    
    <category term="harbor" scheme="https://codezm.github.io/categories/harbor/"/>
    
    
    <category term="docker" scheme="https://codezm.github.io/tags/docker/"/>
    
    <category term="harbor" scheme="https://codezm.github.io/tags/harbor/"/>
    
  </entry>
  
  <entry>
    <title>hhkb-professional-2</title>
    <link href="https://codezm.github.io/posts/%E9%94%AE%E7%9B%98/a18128ef.html"/>
    <id>https://codezm.github.io/posts/%E9%94%AE%E7%9B%98/a18128ef.html</id>
    <published>2025-11-07T10:56:48.000Z</published>
    <updated>2025-12-01T08:02:38.170Z</updated>
    
    <content type="html"><![CDATA[<h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><h3 id="切换大小写"><a href="#切换大小写" class="headerlink" title="切换大小写"></a>切换大小写</h3><p><code>左 Alt</code> + <code>Fn</code> + <code>Tab</code></p><h2 id="图片展示"><a href="#图片展示" class="headerlink" title="图片展示"></a>图片展示</h2><img data-src="/posts/键盘/a18128ef/happy-hacking-professional-2-type-s-keyboard-05.jpg" alt="happy-hacking-professional-2-type-s-keyboard-05" style="zoom:21%;"><img data-src="/posts/键盘/a18128ef/happy-hacking-professional-2-type-s-keyboard-13.jpg" alt="happy-hacking-professional-2-type-s-keyboard-13" style="zoom: 20%;">]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;快捷键&quot;&gt;&lt;a href=&quot;#快捷键&quot; class=&quot;headerlink&quot; title=&quot;快捷键&quot;&gt;&lt;/a&gt;快捷键&lt;/h2&gt;&lt;h3 id=&quot;切换大小写&quot;&gt;&lt;a href=&quot;#切换大小写&quot; class=&quot;headerlink&quot; title=&quot;切换大小写&quot;&gt;&lt;/a&gt;</summary>
      
    
    
    
    <category term="键盘" scheme="https://codezm.github.io/categories/%E9%94%AE%E7%9B%98/"/>
    
    
    <category term="键盘" scheme="https://codezm.github.io/tags/%E9%94%AE%E7%9B%98/"/>
    
    <category term="硬件设备" scheme="https://codezm.github.io/tags/%E7%A1%AC%E4%BB%B6%E8%AE%BE%E5%A4%87/"/>
    
  </entry>
  
  <entry>
    <title>JavaScript 中实用的 API</title>
    <link href="https://codezm.github.io/posts/JavaScript/47110.html"/>
    <id>https://codezm.github.io/posts/JavaScript/47110.html</id>
    <published>2025-09-18T15:06:33.000Z</published>
    <updated>2025-12-01T08:02:38.314Z</updated>
    
    <content type="html"><![CDATA[<p>JavaScript 中实用的 API</p><a id="more"></a><h3 id="1-URL查询参数解析"><a href="#1-URL查询参数解析" class="headerlink" title="1. URL查询参数解析"></a>1. URL查询参数解析</h3><p>过去，要从一个URL中获取查询参数（如 <code>id</code>），我们通常需要使用正则表达式或一连串的 <code>split</code> 方法，代码冗长且容易出错。</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以前的方式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>&nbsp;<span class="title">getQueryParam</span>(<span class="params">url, param</span>) </span>{</span><br><span class="line">&nbsp;<span class="keyword">const</span>&nbsp;search = url.split(<span class="string">'?'</span>)[<span class="number">1</span>];</span><br><span class="line">&nbsp;<span class="keyword">if</span>&nbsp;(!search) {&nbsp;<span class="keyword">return</span>&nbsp;<span class="literal">null</span>; }</span><br><span class="line">&nbsp;<span class="keyword">const</span>&nbsp;params = search.split(<span class="string">'&amp;'</span>);</span><br><span class="line">&nbsp;<span class="keyword">for</span>&nbsp;(<span class="keyword">let</span>&nbsp;i =&nbsp;<span class="number">0</span>; i &lt; params.length; i++) {</span><br><span class="line">&nbsp; &nbsp;&nbsp;<span class="keyword">const</span>&nbsp;pair = params[i].split(<span class="string">'='</span>);</span><br><span class="line">&nbsp; &nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(pair[<span class="number">0</span>] === param) {&nbsp;<span class="keyword">return</span>&nbsp;<span class="built_in">decodeURIComponent</span>(pair[<span class="number">1</span>]); }</span><br><span class="line">&nbsp; }</span><br><span class="line">&nbsp;<span class="keyword">return</span>&nbsp;<span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span>&nbsp;url =&nbsp;<span class="string">'https://example.com/page?id=123&amp;category=tech'</span>;</span><br><span class="line"><span class="keyword">const</span>&nbsp;id =&nbsp;getQueryParam(url,&nbsp;<span class="string">'id'</span>);&nbsp;<span class="comment">// "123"</span></span><br></pre></td></tr></tbody></table></figure><p>现在，<code>URLSearchParams</code> 对象让这一切变得无比简单：</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//现代的方式</span></span><br><span class="line"><span class="keyword">const</span> url = <span class="keyword">new</span> URL(<span class="string">'https://example.com/page?id=123&amp;category=tech'</span>);</span><br><span class="line"><span class="keyword">const</span> id = url.searchParams.get(<span class="string">'id'</span>); <span class="comment">// "123"</span></span><br></pre></td></tr></tbody></table></figure><p>内置的 <code>URLSearchParams</code> 不仅代码更短，而且在处理URL编码、多个同名参数等边缘情况时更加健壮可靠。</p><h3 id="2-对象深拷贝"><a href="#2-对象深拷贝" class="headerlink" title="2. 对象深拷贝"></a>2. 对象深拷贝</h3><p>深拷贝是面试和工作中的常见痛点，最广为人知但有缺陷的方法是 <code>JSON.parse(JSON.stringify(obj))</code>，它无法处理 <code>Date</code> 对象、<code>undefined</code>、等特殊类型。</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span>&nbsp;original = {</span><br><span class="line">&nbsp;&nbsp;birth:&nbsp;<span class="keyword">new</span>&nbsp;<span class="built_in">Date</span>(<span class="string">'1990-01-01'</span>),</span><br><span class="line">&nbsp;&nbsp;id:&nbsp;<span class="literal">undefined</span>,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以前的方式</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;copy =&nbsp;<span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(original));</span><br><span class="line"><span class="comment">// 问题暴露</span></span><br><span class="line"><span class="built_in">console</span>.log(copy.birth);&nbsp;<span class="comment">// "1990-01-01T00:00:00.000Z" (变成了字符串)</span></span><br><span class="line"><span class="built_in">console</span>.log(copy.id); &nbsp;&nbsp;&nbsp;<span class="comment">// undefined (undefined 丢失)</span></span><br></pre></td></tr></tbody></table></figure><p>现在，我们有了原生的、强大的深拷贝工具 <code>structuredClone</code>：</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 现代的方式</span></span><br><span class="line"><span class="keyword">const</span> copy = structuredClone(original);</span><br><span class="line"><span class="comment">// 完美拷贝</span></span><br><span class="line"><span class="built_in">console</span>.log(copy.birth);<span class="comment">// Date object(依然是 Date 对象)</span></span><br><span class="line"><span class="built_in">console</span>.log(original.birth === copy.birth); <span class="comment">// false(是全新的对象)</span></span><br></pre></td></tr></tbody></table></figure><p><code>structuredClone</code> 是官方推荐的深拷贝方式，支持绝大多数数据类型（除函数、DOM节点等），彻底解决了 <code>JSON</code> 方法的弊端。</p><h3 id="3-数组分组"><a href="#3-数组分组" class="headerlink" title="3. 数组分组"></a>3. 数组分组</h3><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span>&nbsp;products = [</span><br><span class="line">&nbsp; {&nbsp;<span class="attr">name</span>:&nbsp;<span class="string">'苹果'</span>,&nbsp;<span class="attr">category</span>:&nbsp;<span class="string">'水果'</span>&nbsp;},</span><br><span class="line">&nbsp; {&nbsp;<span class="attr">name</span>:&nbsp;<span class="string">'电视'</span>,&nbsp;<span class="attr">category</span>:&nbsp;<span class="string">'电器'</span>&nbsp;}</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以前的方式</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;grouped = products.reduce(<span class="function">(<span class="params">acc, product</span>) =&gt;</span>&nbsp;{</span><br><span class="line">&nbsp;<span class="keyword">const</span>&nbsp;key = product.category;</span><br><span class="line">&nbsp;<span class="keyword">if</span>&nbsp;(!acc[key]) { acc[key] = []; }</span><br><span class="line">&nbsp; acc[key].push(product);</span><br><span class="line">&nbsp;<span class="keyword">return</span>&nbsp;acc;</span><br><span class="line">}, {});</span><br><span class="line"><span class="comment">// grouped: { '水果': [...], '电器': [...] }</span></span><br></pre></td></tr></tbody></table></figure><p>ES2023 引入了 <code>Object.groupBy()</code>，让分组操作变得语义化且极其简单。</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 现代的方式</span></span><br><span class="line"><span class="keyword">const</span> grouped = <span class="built_in">Object</span>.groupBy(products, <span class="function"><span class="params">product</span> =&gt;</span> product.category);</span><br><span class="line"><span class="comment">// grouped: { '水果': [...], '电器': [...]}</span></span><br></pre></td></tr></tbody></table></figure><p><code>Object.groupBy()</code> 将一个意图直接翻译成了一行代码，可读性远超复杂的 <code>reduce</code> 实现。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;JavaScript 中实用的 API&lt;/p&gt;</summary>
    
    
    
    <category term="JavaScript" scheme="https://codezm.github.io/categories/JavaScript/"/>
    
    
    <category term="JavaScript" scheme="https://codezm.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>Fetch API 结合 AbortController 实现请求取消与请求超时取消</title>
    <link href="https://codezm.github.io/posts/JavaScript/13368.html"/>
    <id>https://codezm.github.io/posts/JavaScript/13368.html</id>
    <published>2025-09-18T14:54:57.000Z</published>
    <updated>2025-12-01T08:02:38.314Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Fetch-API-结合-AbortController-实现请求取消与请求超时取消"><a href="#Fetch-API-结合-AbortController-实现请求取消与请求超时取消" class="headerlink" title="Fetch API 结合 AbortController 实现请求取消与请求超时取消"></a>Fetch API 结合 AbortController 实现请求取消与请求超时取消</h2><a id="more"></a><h3 id="1-请求取消"><a href="#1-请求取消" class="headerlink" title="1. 请求取消"></a>1. 请求取消</h3><blockquote><p>想象一个场景：用户在搜索框中快速输入，每次输入都触发一次请求。我们只关心最后一次请求的结果。使用 <code>AbortController</code>，实现起来易如反掌。</p></blockquote><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span>&nbsp;controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span>&nbsp;<span class="function"><span class="keyword">function</span>&nbsp;<span class="title">handleSearch</span>(<span class="params">query</span>) </span>{</span><br><span class="line">&nbsp;<span class="comment">// 如果上一个请求正在进行，取消它</span></span><br><span class="line">&nbsp;<span class="keyword">if</span>&nbsp;(controller) {</span><br><span class="line">&nbsp; &nbsp; controller.abort();</span><br><span class="line">&nbsp; }</span><br><span class="line"></span><br><span class="line">&nbsp;<span class="comment">// 为新请求创建一个新的控制器</span></span><br><span class="line">&nbsp;controller =&nbsp;<span class="keyword">new</span>&nbsp;AbortController();</span><br><span class="line">&nbsp;<span class="keyword">const</span>&nbsp;signal = controller.signal;</span><br><span class="line"></span><br><span class="line">&nbsp;<span class="keyword">try</span>&nbsp;{</span><br><span class="line">&nbsp; &nbsp;&nbsp;<span class="keyword">const</span>&nbsp;response =&nbsp;<span class="keyword">await</span>&nbsp;fetch(<span class="string">`/api/search?q=<span class="subst">${query}</span>`</span>, { signal });</span><br><span class="line">&nbsp; &nbsp;&nbsp;<span class="keyword">const</span>&nbsp;data =&nbsp;<span class="keyword">await</span>&nbsp;response.json();</span><br><span class="line">&nbsp; &nbsp;&nbsp;<span class="built_in">console</span>.log(<span class="string">'Search results:'</span>, data);</span><br><span class="line">&nbsp; }&nbsp;<span class="keyword">catch</span>&nbsp;(error) {</span><br><span class="line">&nbsp; &nbsp;&nbsp;<span class="keyword">if</span>&nbsp;(error.name&nbsp;===&nbsp;<span class="string">'AbortError'</span>) {</span><br><span class="line">&nbsp; &nbsp; &nbsp;&nbsp;<span class="built_in">console</span>.log(<span class="string">'Fetch aborted'</span>);</span><br><span class="line">&nbsp; &nbsp; }&nbsp;<span class="keyword">else</span>&nbsp;{</span><br><span class="line">&nbsp; &nbsp; &nbsp;&nbsp;<span class="built_in">console</span>.error(<span class="string">'Fetch error:'</span>, error);</span><br><span class="line">&nbsp; &nbsp; }</span><br><span class="line">&nbsp; }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="3-请求超时"><a href="#3-请求超时" class="headerlink" title="3. 请求超时"></a>3. 请求超时</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchWithTimeout</span>(<span class="params">resource, options ={}, timeout = <span class="number">8000</span></span>)</span>{</span><br><span class="line">  <span class="keyword">const</span> controller = <span class="keyword">new</span> AbortController();</span><br><span class="line">  <span class="keyword">const</span> id = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> controller.abort(), timeout);</span><br><span class="line"><span class="keyword">const</span> response = <span class="keyword">await</span> fetch(resource, {</span><br><span class="line">    ...options, </span><br><span class="line">    signal: controller.signal</span><br><span class="line">  });</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">clearTimeout</span>(id);</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> fetchWithTimeout(<span class="string">'/api/slow-data'</span>, {}, <span class="number">5000</span>);<span class="comment">// 5秒超时</span></span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> response.json();</span><br><span class="line">  <span class="built_in">console</span>.log(data);</span><br><span class="line">} <span class="keyword">catch</span> (error){</span><br><span class="line"><span class="keyword">if</span>(error.name ==<span class="string">'AbortError'</span>){</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Fetch request timed out.'</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Fetch-API-结合-AbortController-实现请求取消与请求超时取消&quot;&gt;&lt;a href=&quot;#Fetch-API-结合-AbortController-实现请求取消与请求超时取消&quot; class=&quot;headerlink&quot; title=&quot;Fetch API 结合 AbortController 实现请求取消与请求超时取消&quot;&gt;&lt;/a&gt;Fetch API 结合 AbortController 实现请求取消与请求超时取消&lt;/h2&gt;</summary>
    
    
    
    <category term="JavaScript" scheme="https://codezm.github.io/categories/JavaScript/"/>
    
    
    <category term="JavaScript" scheme="https://codezm.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>16 个 JavaScript 简写神技</title>
    <link href="https://codezm.github.io/posts/JavaScript/33991.html"/>
    <id>https://codezm.github.io/posts/JavaScript/33991.html</id>
    <published>2025-09-18T14:40:14.000Z</published>
    <updated>2025-12-01T08:02:38.314Z</updated>
    
    <content type="html"><![CDATA[<h2 id="16-个-JavaScript-简写神技"><a href="#16-个-JavaScript-简写神技" class="headerlink" title="16 个 JavaScript 简写神技"></a>16 个 JavaScript 简写神技</h2><p>JavaScript 是一门强大且灵活的语言，拥有丰富的特性和语法糖。分享下 16 个最常用的 JavaScript 的简写技巧，掌握它们可以让我们编写出更简洁、更优雅的代码，并显著提升开发效率（增加摸鱼时间）。</p><a id="more"></a><h3 id="1-三元运算符简化条件判断"><a href="#1-三元运算符简化条件判断" class="headerlink" title="1. 三元运算符简化条件判断"></a>1. 三元运算符简化条件判断</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">let</span>&nbsp;result;</span><br><span class="line"><span class="keyword">if</span>&nbsp;(someCondition) {</span><br><span class="line">&nbsp; &nbsp; result =&nbsp;<span class="string">'yes'</span>;</span><br><span class="line">}&nbsp;<span class="keyword">else</span>&nbsp;{</span><br><span class="line">&nbsp; &nbsp; result =&nbsp;<span class="string">'no'</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;result = someCondition ?&nbsp;<span class="string">'yes'</span>&nbsp;:&nbsp;<span class="string">'no'</span>;</span><br></pre></td></tr></tbody></table></figure><h3 id="2-空值合并运算符"><a href="#2-空值合并运算符" class="headerlink" title="2. 空值合并运算符"></a>2. 空值合并运算符</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">const</span> name = user.name !== <span class="literal">null</span> &amp;&amp; user.name != <span class="literal">undefined</span> ? user.name : <span class="string">'default'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span> name = user.name ?? <span class="string">'default'</span></span><br></pre></td></tr></tbody></table></figure><h3 id="3-可选链操作符"><a href="#3-可选链操作符" class="headerlink" title="3. 可选链操作符"></a>3. 可选链操作符</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;street = user &amp;&amp; user.address&nbsp;&amp;&amp; user.address.street;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;street = user?.address?.street;</span><br></pre></td></tr></tbody></table></figure><h3 id="4-数组去重"><a href="#4-数组去重" class="headerlink" title="4. 数组去重"></a>4. 数组去重</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unique</span>(<span class="params">arr</span>)</span>{</span><br><span class="line">  <span class="keyword">return</span> arr.filter(<span class="function">(<span class="params">item, index</span>) =&gt;</span> arr.index0f(item) === index);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span> unique = <span class="function"><span class="params">arr</span> =&gt;</span> [...new <span class="built_in">Set</span>(arr)];</span><br></pre></td></tr></tbody></table></figure><h3 id="5-快速取整"><a href="#5-快速取整" class="headerlink" title="5. 快速取整"></a>5. 快速取整</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;floor =&nbsp;<span class="built_in">Math</span>.floor(<span class="number">4.9</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;floor = ~~<span class="number">4.9</span>;</span><br></pre></td></tr></tbody></table></figure><h3 id="6-合并对象"><a href="#6-合并对象" class="headerlink" title="6. 合并对象"></a>6. 合并对象</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">const</span> merged = object.assign({}, obj1, obj2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span> merged = {...obj1, ...obj2};</span><br></pre></td></tr></tbody></table></figure><h3 id="7-短路求值"><a href="#7-短路求值" class="headerlink" title="7. 短路求值"></a>7. 短路求值</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">if</span>&nbsp;(condition) {</span><br><span class="line">&nbsp; &nbsp;&nbsp;doSomething();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line">condition &amp;&amp;&nbsp;doSomething();</span><br></pre></td></tr></tbody></table></figure><h3 id="8-默认参数值"><a href="#8-默认参数值" class="headerlink" title="8. 默认参数值"></a>8. 默认参数值</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>&nbsp;<span class="title">greet</span>(<span class="params">name</span>) </span>{</span><br><span class="line">&nbsp; &nbsp; name = name ||&nbsp;<span class="string">'Guest'</span>;</span><br><span class="line">&nbsp; &nbsp;&nbsp;<span class="built_in">console</span>.log(<span class="string">`Hello&nbsp;<span class="subst">${name}</span>`</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;greet&nbsp;= <span class="function">(<span class="params">name =&nbsp;<span class="string">'Guest'</span></span>) =&gt;</span>&nbsp;<span class="built_in">console</span>.log(<span class="string">`Hello&nbsp;<span class="subst">${name}</span>`</span>);</span><br></pre></td></tr></tbody></table></figure><h3 id="9-解构赋值"><a href="#9-解构赋值" class="headerlink" title="9. 解构赋值"></a>9. 解构赋值</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;first = arr[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">const</span>&nbsp;second = arr[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;[first, second] = arr;</span><br></pre></td></tr></tbody></table></figure><h3 id="10-字符串转数字"><a href="#10-字符串转数字" class="headerlink" title="10. 字符串转数字"></a>10. 字符串转数字</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;num =&nbsp;<span class="built_in">parseInt</span>(<span class="string">'123'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;num = +<span class="string">'123'</span>;</span><br></pre></td></tr></tbody></table></figure><h3 id="11-多重条件判断"><a href="#11-多重条件判断" class="headerlink" title="11. 多重条件判断"></a>11. 多重条件判断</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">if</span>&nbsp;(value ===&nbsp;<span class="number">1</span>&nbsp;|| value ===&nbsp;<span class="number">2</span>&nbsp;|| value ===&nbsp;<span class="number">3</span>) {</span><br><span class="line">&nbsp; &nbsp;&nbsp;<span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">if</span>&nbsp;([<span class="number">1</span>,&nbsp;<span class="number">2</span>,&nbsp;<span class="number">3</span>].includes(value)) {</span><br><span class="line">&nbsp; &nbsp;&nbsp;<span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="12-快速幂运算"><a href="#12-快速幂运算" class="headerlink" title="12. 快速幂运算"></a>12. 快速幂运算</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="built_in">Math</span>.pow(<span class="number">2</span>,&nbsp;<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="number">2</span>&nbsp;**&nbsp;<span class="number">3</span>;</span><br></pre></td></tr></tbody></table></figure><h3 id="13-对象属性简写"><a href="#13-对象属性简写" class="headerlink" title="13. 对象属性简写"></a>13. 对象属性简写</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;obj = {&nbsp;<span class="attr">x</span>: x,&nbsp;<span class="attr">y</span>: y };</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span>&nbsp;obj = { x, y };</span><br></pre></td></tr></tbody></table></figure><h3 id="14-数组映射"><a href="#14-数组映射" class="headerlink" title="14. 数组映射"></a>14. 数组映射</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">const</span> doubled = numbers.map(<span class="function"><span class="keyword">function</span>(<span class="params">num</span>) </span>{</span><br><span class="line">    <span class="keyword">return</span> num * <span class="number">2</span>;</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span> doubled = numbers.map(<span class="function"><span class="params">num</span> =&gt;</span> num * <span class="number">2</span>);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="15-交换变量值"><a href="#15-交换变量值" class="headerlink" title="15. 交换变量值"></a>15. 交换变量值</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">let</span> temp = a;</span><br><span class="line">a = b;</span><br><span class="line">b = temp;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line">[a, b] = [b, a];</span><br></pre></td></tr></tbody></table></figure><h3 id="16-动态对象属性"><a href="#16-动态对象属性" class="headerlink" title="16. 动态对象属性"></a>16. 动态对象属性</h3><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传统写法</span></span><br><span class="line"><span class="keyword">const</span> obj = {};</span><br><span class="line">obj[dynamic + <span class="string">'name'</span>] = value;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简写方式</span></span><br><span class="line"><span class="keyword">const</span> obj = {</span><br><span class="line">[<span class="string">`<span class="subst">${dynamic}</span>name`</span>]: value</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://mp.weixin.qq.com/s/OfnTUDWr-sOmAl9CxeM2tg">https://mp.weixin.qq.com/s/OfnTUDWr-sOmAl9CxeM2tg</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;16-个-JavaScript-简写神技&quot;&gt;&lt;a href=&quot;#16-个-JavaScript-简写神技&quot; class=&quot;headerlink&quot; title=&quot;16 个 JavaScript 简写神技&quot;&gt;&lt;/a&gt;16 个 JavaScript 简写神技&lt;/h2&gt;&lt;p&gt;JavaScript 是一门强大且灵活的语言，拥有丰富的特性和语法糖。分享下 16 个最常用的 JavaScript 的简写技巧，掌握它们可以让我们编写出更简洁、更优雅的代码，并显著提升开发效率（增加摸鱼时间）。&lt;/p&gt;</summary>
    
    
    
    <category term="JavaScript" scheme="https://codezm.github.io/categories/JavaScript/"/>
    
    
    <category term="JavaScript" scheme="https://codezm.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>Chrome麦克风授权</title>
    <link href="https://codezm.github.io/posts/Chrome/e3041ae8.html"/>
    <id>https://codezm.github.io/posts/Chrome/e3041ae8.html</id>
    <published>2025-09-18T00:00:00.000Z</published>
    <updated>2025-12-01T08:02:38.160Z</updated>
    
    <content type="html"><![CDATA[<p>使用 127.0.0.1、localhost及 https 可以正常获取麦克风权限。如果使用的是局域网 IP 地址则需要设置信任的地址</p><h3 id="信任的地址配置"><a href="#信任的地址配置" class="headerlink" title="信任的地址配置"></a>信任的地址配置</h3><p><a href="chrome://flags/#unsafely-treat-insecure-origin-as-secure">chrome://flags/#unsafely-treat-insecure-origin-as-secure</a></p><p><img data-src="/posts/Chrome/e3041ae8/image-20250918103132601.png" alt="image-20250918103132601"></p><blockquote><p>启用后需要重启 Chrome 浏览器，重启后就能成功调起麦克风。</p></blockquote><h3 id="如何设置麦克风设备"><a href="#如何设置麦克风设备" class="headerlink" title="如何设置麦克风设备"></a>如何设置麦克风设备</h3><ol><li>打开浏览器 <strong>设置</strong>：chrome://settings/。</li><li>依次选择<strong>隐私和安全</strong> 、 <strong>网站设置</strong>。</li><li>在“权限”下，选择<strong>麦克风</strong>。</li><li>如需选择默认麦克风，请选择向下箭头 。</li></ol><img data-src="/posts/Chrome/e3041ae8/image-20250928110414005.png" alt="image-20250928110414005" style="zoom:50%;"><p>查看当前设置的麦克风设备：</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">navigator.mediaDevices.getUserMedia({ <span class="attr">audio</span>: <span class="literal">true</span> })</span><br><span class="line">  .then(<span class="function">(<span class="params">stream</span>) =&gt;</span> {</span><br><span class="line">  <span class="comment">// 获取音频轨道</span></span><br><span class="line">  <span class="keyword">const</span> audioTracks = stream.getAudioTracks();</span><br><span class="line">  <span class="keyword">if</span> (audioTracks.length &gt; <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">const</span> audioTrack = audioTracks[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> audioSettings = audioTrack.getSettings();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"音频设备 ID:"</span>, audioSettings.deviceId);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"音频设备标签:"</span>, audioTrack.label); <span class="comment">// 可能为空（需用户授权）</span></span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先请求用户权限（这是必要的，否则设备标签可能被隐藏）</span></span><br><span class="line">navigator.mediaDevices.getUserMedia({ <span class="attr">audio</span>: <span class="literal">true</span> })</span><br><span class="line">  .then(<span class="function"><span class="params">stream</span> =&gt;</span> {</span><br><span class="line">    <span class="comment">// 即使我们不需要流，也需要请求权限才能获取设备标签</span></span><br><span class="line">    <span class="comment">// 获取设备列表</span></span><br><span class="line">    <span class="keyword">return</span> navigator.mediaDevices.enumerateDevices();</span><br><span class="line">  })</span><br><span class="line">  .then(<span class="function"><span class="params">devices</span> =&gt;</span> {</span><br><span class="line">    <span class="comment">// 筛选出音频输入设备</span></span><br><span class="line">    <span class="keyword">const</span> audioInputs = devices.filter(<span class="function"><span class="params">device</span> =&gt;</span> device.kind === <span class="string">'audioinput'</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'可用的音频输入设备:'</span>, audioInputs);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理设备列表</span></span><br><span class="line">    audioInputs.forEach(<span class="function"><span class="params">device</span> =&gt;</span> {</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`设备ID: <span class="subst">${device.deviceId}</span>`</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`设备标签: <span class="subst">${device.label || <span class="string">'未命名设备'</span>}</span>`</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`设备类型: <span class="subst">${device.kind}</span>`</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'-------------------'</span>);</span><br><span class="line">    });</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果你想停止获取的音频流（因为我们只需要权限）</span></span><br><span class="line">    <span class="keyword">if</span> (stream) {</span><br><span class="line">      stream.getTracks().forEach(<span class="function"><span class="params">track</span> =&gt;</span> track.stop());</span><br><span class="line">    }</span><br><span class="line">  })</span><br><span class="line">  .catch(<span class="function"><span class="params">error</span> =&gt;</span> {</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'获取设备时出错:'</span>, error);</span><br><span class="line">  });</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;使用 127.0.0.1、localhost及 https 可以正常获取麦克风权限。如果使用的是局域网 IP 地址则需要设置信任的地址&lt;/p&gt;
&lt;h3 id=&quot;信任的地址配置&quot;&gt;&lt;a href=&quot;#信任的地址配置&quot; class=&quot;headerlink&quot; title=&quot;信任的</summary>
      
    
    
    
    <category term="Chrome" scheme="https://codezm.github.io/categories/Chrome/"/>
    
    
    <category term="Chrome" scheme="https://codezm.github.io/tags/Chrome/"/>
    
    <category term="JavaScript" scheme="https://codezm.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>大屏抽奖项目总结</title>
    <link href="https://codezm.github.io/posts/Project/7b8a2e1a.html"/>
    <id>https://codezm.github.io/posts/Project/7b8a2e1a.html</id>
    <published>2024-10-16T11:51:24.000Z</published>
    <updated>2025-12-01T08:02:38.210Z</updated>
    
    <content type="html"><![CDATA[<p>本次大屏抽奖项目采用纯前端技术实现。</p><a id="more"></a><h2 id="项目需求"><a href="#项目需求" class="headerlink" title="项目需求"></a>项目需求</h2><ol><li>一等奖与其他奖项的抽奖人员名单不同。</li><li>三等奖需抽取两次。</li><li>抽奖人员名单在抽奖当日提供 Excel 文件。</li><li>大屏展示抽奖页面，共有三种状态切换：<ol><li>等待抽奖：抽奖未开始时展示效果。</li><li>开始抽奖：动画展示抽奖人员名单。</li><li>停止抽奖：展示中奖人员名单。</li></ol></li></ol><h2 id="项目实现方案"><a href="#项目实现方案" class="headerlink" title="项目实现方案"></a>项目实现方案</h2><p>设计页面介绍：</p><ol><li>抽奖页：此页面将投放至大屏展示。</li><li>抽奖操控页：此页面由抽奖人根据主持人指示操作开始、结束抽奖。</li><li>Excel 文件数据提取页：用于将甲方提供的中奖人员名单转换成 <code>json</code> 数据格式保存至 <code>localStorage</code> 中。</li><li>恢复页：用于恢复抽奖页状态。<ol><li>各奖项抽奖中、各奖项中奖人员名单。</li><li>等待抽奖。</li><li>导出中奖人员名单：将中奖人员的 <code>json</code> 数据导出至 Excel 文件中。</li></ol></li></ol><p>项目采用 <code>localStorage</code> 来进行页面间的消息存储。</p><ul><li><p>抽奖页通过 <code>setIntval</code> 定时器监听 <code>localStorage</code> 中<code>操作项</code>值的变化，来进行页面中元素展现。</p></li><li><p>抽奖操控页实现奖品的抽取及操作项状态的变更。</p></li></ul><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol><li><p>页面设计的尺寸在大屏上展示的效果不理想：可以试试 <code>ctrl -</code> 、<code>ctrl +</code> 缩放下页面。</p><blockquote><p>大屏也只是个屏幕而已，电脑连接上后，选择扩展屏幕，将抽奖页拖动到大屏屏幕，然后全屏展示即可：</p><ul><li><p>Windows：<code>F11</code> 全屏。</p></li><li><p>MacOS：<code>Command</code> + <code>Ctrl</code> +  <code>F</code> Chrome窗口最大化（隐藏菜单栏及Docker栏），<code>Command</code> + <code>Shift</code> + <code>F</code> Chrome全屏（隐藏Chrome 的 tab 标签栏及地址栏）。</p></li></ul></blockquote></li><li><p>注意原数据格式问题：因甲方提供的是 Excel 文件，其中的人员名单保存到 json 中时要特别注意人名中有可能存在 <code>\n</code>，<code>\t</code> 等特殊字符，这些特殊字符需提前处理掉，不然在中奖名单中就会像这样展示：<code>王\t五</code>。</p></li><li><p>注意中奖人员姓名拼接问题：甲方提供的人员名单中 <code>姓</code> 与 <code>名</code> 是拆开的。在对其进行合并时要注意中文姓名中间不能加空格，英文姓名则需要加空格。</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAllChinese</span>(<span class="params">str</span>) </span>{</span><br><span class="line">  <span class="keyword">const</span> reg = <span class="regexp">/[^\u4e00-\u9fa5]/</span>;</span><br><span class="line">  <span class="keyword">return</span> !reg.test(str);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li><li><p>注意抽奖端操控便利性问题：鼠标点击不如键位便捷准确，在进行奖品选项选择时可通过监听键盘：数字1、数字2、数字3 来对应奖品：一等奖、二等奖、三等奖。绑定 <code>Enter</code> 键代替鼠标点击 <code>开始抽奖</code>、<code>停止抽奖</code>、<code>返回</code> 按钮。</p><blockquote><ol><li>你不知道场控方提供的电脑是否带外接鼠标，场地是否有足够的空间来操作鼠标。警惕：<strong>触摸板</strong>。</li><li>第二个为什么要用键盘来代替鼠标的理由：你看看中控台就知道了，全是实体键位操控。</li></ol></blockquote></li><li><p>注意采集卡传输分辨率。</p><p>如果采集卡传输分辨率是1920*1080，而屏显分辨率是 2048*768。则页面设计的时候最好做两版。因为你不知道场控方是否可以调整采集卡分辨率，调整后是否有背景图失真情况。</p><blockquote><p>在彩排时发现图片及文字在最终屏幕上有变形，经与场控方沟通后才得知采集卡分辨率是1920*1080，而我们是按照屏显 2048*768做的。在配合场控方调整外屏分辨率时，虽然文字及图片显示正常了，但是图片失真很严重。在调回原始分辨率后图片也失真，无法还原到初始状态了。更换到另一个采集卡</p></blockquote></li></ol><h2 id="项目收尾"><a href="#项目收尾" class="headerlink" title="项目收尾"></a>项目收尾</h2><p>因程序是放在场控方提供的电脑上运行，应甲方数据保密要求需处理好善后工作。</p><ol><li><p>清除 <code>localStroage</code> 中的全部数据。</p></li><li><p>删除抽奖程序：<code>shift</code> + <code>delete</code> 键删除。</p><blockquote><p>这里有个小插曲哈，第一次删除的时候没按 <code>shift</code> 键，文件进到回收站了，而回收站又打不开：</p><p><code>Win + R</code> 打开 <code>cmd</code> 命令行。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rd /s /q C:<span class="variable">$Recycle</span>.Bin</span><br></pre></td></tr></tbody></table></figure></blockquote></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;本次大屏抽奖项目采用纯前端技术实现。&lt;/p&gt;</summary>
    
    
    
    <category term="Project" scheme="https://codezm.github.io/categories/Project/"/>
    
    
    <category term="Project" scheme="https://codezm.github.io/tags/Project/"/>
    
  </entry>
  
  <entry>
    <title>MacOS设置sshd服务免密登录</title>
    <link href="https://codezm.github.io/posts/MacOS/8dd9e79a.html"/>
    <id>https://codezm.github.io/posts/MacOS/8dd9e79a.html</id>
    <published>2024-05-28T10:12:34.000Z</published>
    <updated>2025-12-01T08:02:38.200Z</updated>
    
    <content type="html"><![CDATA[<h1 id="MacOS设置sshd服务免密登录"><a href="#MacOS设置sshd服务免密登录" class="headerlink" title="MacOS设置sshd服务免密登录"></a>MacOS设置sshd服务免密登录</h1><p>本篇将介绍如何使用免密证书的方式登录 MacOS 系统。</p><a id="more"></a><h2 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h2><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -c "codezm@163.com"</span><br></pre></td></tr></tbody></table></figure><h2 id="安装证书"><a href="#安装证书" class="headerlink" title="安装证书"></a>安装证书</h2><blockquote><p>将公钥证书安装到 <code>192.168.36.47</code> MacOS 机器。</p></blockquote><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub codezm@192.168.36.47</span><br></pre></td></tr></tbody></table></figure><h2 id="确认免密登录"><a href="#确认免密登录" class="headerlink" title="确认免密登录"></a>确认免密登录</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若私钥文件名是 id_rsa，那么 -i ~/.ssh/id_rsa 参数可省略。</span></span><br><span class="line">ssh -i ~/.ssh/id_rsa codezm@192.168.36.47</span><br><span class="line"></span><br><span class="line"><span class="comment"># 若私钥文件名不是 id_rsa，今后登录时也不想指定证书文件。</span></span><br><span class="line"><span class="comment"># 有以下两种方式：</span></span><br><span class="line"><span class="comment"># 1. 可以将私钥添加到身份验证密钥管理工具：ssh-add。之后登录就不需要指定私钥路径了。</span></span><br><span class="line">ssh-add -K id_rsa</span><br><span class="line"><span class="comment"># 2.编辑文件： ~/.ssh/config</span></span><br><span class="line">Host 192.168.36.47</span><br><span class="line">    HostName 192.168.36.47</span><br><span class="line">    IdentityFile ~/.ssh/id_rsa</span><br></pre></td></tr></tbody></table></figure><h2 id="关闭账号密码登录"><a href="#关闭账号密码登录" class="headerlink" title="关闭账号密码登录"></a>关闭账号密码登录</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ssh/sshd_config</span><br></pre></td></tr></tbody></table></figure><p>向文件尾部追加以下内容：</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 禁用密码认证</span><br><span class="line">PasswordAuthentication no</span><br><span class="line"></span><br><span class="line"># 禁用键盘交互认证</span><br><span class="line">KbdInteractiveAuthentication no</span><br><span class="line"></span><br><span class="line"># 确保启用公钥认证</span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line"></span><br><span class="line"># 禁用挑战-响应认证</span><br><span class="line">ChallengeResponseAuthentication no</span><br></pre></td></tr></tbody></table></figure><p>重启 sshd 服务，使配置生效。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist</span><br><span class="line">sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist</span><br></pre></td></tr></tbody></table></figure><h2 id="记录免密登录失败分析思路"><a href="#记录免密登录失败分析思路" class="headerlink" title="记录免密登录失败分析思路"></a>记录免密登录失败分析思路</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">log</span> show --predicate <span class="string">'process == "sshd"'</span> --info --last 10</span><br><span class="line"></span><br><span class="line">Filtering the <span class="built_in">log</span> data using <span class="string">"process == "</span>sshd<span class="string">""</span></span><br><span class="line">Skipping debug messages, pass --debug to include.</span><br><span class="line">Timestamp                       Thread     Type        Activity             PID    TTL</span><br><span class="line">2024-05-28 09:59:33.732102+0800 0x7ff0     Info        0x0                  6224   0    sshd: Authentication refused: bad ownership or modes <span class="keyword">for</span> directory /Volumes/work</span><br></pre></td></tr></tbody></table></figure><p>问题原因是由软链引起的。</p><blockquote><p>初衷是想将 .ssh 目录放到 dotfile 中由 Git 统一管理维护，但万万没想到竟然造成 sshd 无法实现免密证书登录。</p></blockquote><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /Users/codezm/.config/dotfile/.ssh ~/.ssh</span><br><span class="line">ln -s /Volumes/work/envconfig ~/.config</span><br></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;MacOS设置sshd服务免密登录&quot;&gt;&lt;a href=&quot;#MacOS设置sshd服务免密登录&quot; class=&quot;headerlink&quot; title=&quot;MacOS设置sshd服务免密登录&quot;&gt;&lt;/a&gt;MacOS设置sshd服务免密登录&lt;/h1&gt;&lt;p&gt;本篇将介绍如何使用免密证书的方式登录 MacOS 系统。&lt;/p&gt;</summary>
    
    
    
    <category term="MacOS" scheme="https://codezm.github.io/categories/MacOS/"/>
    
    
    <category term="MacOS" scheme="https://codezm.github.io/tags/MacOS/"/>
    
  </entry>
  
  <entry>
    <title>MacOS快捷键</title>
    <link href="https://codezm.github.io/posts/MacOS/kjj.html"/>
    <id>https://codezm.github.io/posts/MacOS/kjj.html</id>
    <published>2024-05-24T09:35:43.000Z</published>
    <updated>2025-12-01T08:02:38.200Z</updated>
    
    <content type="html"><![CDATA[<h1 id="MacOS快捷键"><a href="#MacOS快捷键" class="headerlink" title="MacOS快捷键"></a>MacOS快捷键</h1><table><thead><tr><th>功能</th><th>快捷键</th></tr></thead><tbody><tr><td>截全屏图</td><td>Command+Shift+3</td></tr><tr><td>自定义截图</td><td>Command+Shift+4</td></tr><tr><td>截屏或录屏</td><td>Command+Shift+5</td></tr><tr><td>立即锁定屏幕</td><td>Control + Command + Q</td></tr><tr><td>退出登录你的 macOS 用户账户。系统将提示你进行确认。<br>要在不确认的情况下立即退出登录，请按下 Option-Shift-Command-Q。</td><td>Command + Shift + Q</td></tr><tr><td>将最前方的窗口最小化至程序坞。</td><td>Command-M</td></tr><tr><td></td><td></td></tr><tr><td>访达</td><td></td></tr><tr><td>创建一个新文件夹</td><td>Shift-Command-N</td></tr><tr><td>推出所选磁盘或宗卷。</td><td>Command-E</td></tr><tr><td>打开“桌面”文件夹</td><td>Shift-Command-D</td></tr><tr><td>打开“最近使用”窗口，其中会显示你最近查看或更改过的所有文件。</td><td>Shift-Command-F</td></tr><tr><td>打开“前往文件夹”窗口。</td><td>Shift-Command-G</td></tr><tr><td>打开当前 macOS 用户账户的个人文件夹。</td><td>Shift-Command-H</td></tr><tr><td>打开“网络”窗口</td><td>Shift-Command-K</td></tr><tr><td>打开“下载”文件夹</td><td>Option-Command-L</td></tr><tr><td>前往上一个文件夹。</td><td>Command-左中括号 ([)</td></tr><tr><td>前往下一个文件夹。</td><td>Command-右中括号 (])</td></tr><tr><td>打开包含当前文件夹的文件夹。</td><td>Command-上箭头</td></tr><tr><td>在一个新窗口中打开包含当前文件夹的文件夹。</td><td>Command-Control-上箭头</td></tr><tr><td>打开所选项目。</td><td>Command-下箭头</td></tr></tbody></table><p><a href="https://support.apple.com/zh-cn/102650">Mac 键盘快捷键</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;MacOS快捷键&quot;&gt;&lt;a href=&quot;#MacOS快捷键&quot; class=&quot;headerlink&quot; title=&quot;MacOS快捷键&quot;&gt;&lt;/a&gt;MacOS快捷键&lt;/h1&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;功能&lt;/th&gt;
&lt;th&gt;快捷键&lt;/th&gt;
&lt;/t</summary>
      
    
    
    
    <category term="MacOS" scheme="https://codezm.github.io/categories/MacOS/"/>
    
    
    <category term="MacOS" scheme="https://codezm.github.io/tags/MacOS/"/>
    
  </entry>
  
  <entry>
    <title>快捷键汇总</title>
    <link href="https://codezm.github.io/kjj.html"/>
    <id>https://codezm.github.io/kjj.html</id>
    <published>2024-05-23T16:20:44.000Z</published>
    <updated>2025-12-01T08:02:38.294Z</updated>
    
    <content type="html"><![CDATA[<h1 id="快捷键汇总"><a href="#快捷键汇总" class="headerlink" title="快捷键汇总"></a>快捷键汇总</h1><pre class="mermaid">graph LR  A[快捷键]---AA[fa:fa-apple MacOS操作系统 fa:fa-link]  AA-.-AAB[fa:fa-link Typora]  AA-.-AAC[fa:fa-link NeoVim]  A[快捷键]---AB[fa:fa-windows Windows操作系统 fa:fa-link]  A[快捷键]---AC[VSCode fa:fa-link]  A[快捷键]---AD[IDEA fa:fa-link]  A[快捷键]---AE[Chrome fa:fa-link]  A[快捷键]---AF[HHKB键盘图 fa:fa-link]  AB-.-ABB[fa:fa-link Typora]  AB-.-ABC[fa:fa-link NeoVim]  ABC---ABCA[fa:fa-link Vim]    click AA "/posts/MacOS/kjj.html"    click AB "/posts/Windows/kjj.html"    click AC "/posts/VSCode/kjj.html"    click AD "/posts/IDEA/kjj.html"  click AE "/posts/Chrome/kjj.html"  click AF "/images/hhkb.jpg"  click AAB "https://support.typora.io/Shortcut-Keys/"  click ABCA "https://www.runoob.com/w3cnote/all-vim-cheatsheat.html"</pre><a id="more"></a><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://mermaid.live/">https://mermaid.live/</a></p><p><a href="https://zhuanlan.zhihu.com/p/355997933">https://zhuanlan.zhihu.com/p/355997933</a></p><p><a href="https://csnotes.gitlab.io/csnotes/tools/markdown/mermaid.html">https://csnotes.gitlab.io/csnotes/tools/markdown/mermaid.html</a></p><p><a href="https://fontawesome.com/icons?d=gallery">Mermaid 支持的图标</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;快捷键汇总&quot;&gt;&lt;a href=&quot;#快捷键汇总&quot; class=&quot;headerlink&quot; title=&quot;快捷键汇总&quot;&gt;&lt;/a&gt;快捷键汇总&lt;/h1&gt;&lt;pre class=&quot;mermaid&quot;&gt;graph LR
  A[快捷键]---AA[fa:fa-apple MacOS操作系统 fa:fa-link]


  AA-.-AAB[fa:fa-link Typora]
  AA-.-AAC[fa:fa-link NeoVim]
  A[快捷键]---AB[fa:fa-windows Windows操作系统 fa:fa-link]
  A[快捷键]---AC[VSCode fa:fa-link]
  A[快捷键]---AD[IDEA fa:fa-link]
  A[快捷键]---AE[Chrome fa:fa-link]
  A[快捷键]---AF[HHKB键盘图 fa:fa-link]

  AB-.-ABB[fa:fa-link Typora]
  AB-.-ABC[fa:fa-link NeoVim]
  ABC---ABCA[fa:fa-link Vim]

    click AA &quot;/posts/MacOS/kjj.html&quot;
    click AB &quot;/posts/Windows/kjj.html&quot;
    click AC &quot;/posts/VSCode/kjj.html&quot;
    click AD &quot;/posts/IDEA/kjj.html&quot;
  click AE &quot;/posts/Chrome/kjj.html&quot;
  click AF &quot;/images/hhkb.jpg&quot;
  click AAB &quot;https://support.typora.io/Shortcut-Keys/&quot;
  click ABCA &quot;https://www.runoob.com/w3cnote/all-vim-cheatsheat.html&quot;&lt;/pre&gt;</summary>
    
    
    
    <category term="快捷键" scheme="https://codezm.github.io/categories/%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    
    
    <category term="快捷键" scheme="https://codezm.github.io/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    
  </entry>
  
  <entry>
    <title>若依用户分表鉴权</title>
    <link href="https://codezm.github.io/posts/java/d3954bd.html"/>
    <id>https://codezm.github.io/posts/java/d3954bd.html</id>
    <published>2024-05-15T14:59:00.000Z</published>
    <updated>2025-12-01T08:02:38.314Z</updated>
    
    <content type="html"><![CDATA[<h1 id="若依用户分表鉴权"><a href="#若依用户分表鉴权" class="headerlink" title="若依用户分表鉴权"></a>若依用户分表鉴权</h1><p>若依自带了管理后台及服务端，但项目通常还有客户端业务。那客户端如何实现鉴权？最简单的方式是在原有的 sys_user 上增加业务逻辑，但随着项目越做越大耦合度也会成倍增加。那解耦就势在必行。</p><p>本篇将介绍如何让客户端拥有一套独立表来实现用户鉴权。完整代码<a href="https://github.com/codezm/codezm-auths">参见</a>。</p><a id="more"></a><h2 id="创建-auths-Maven-模块"><a href="#创建-auths-Maven-模块" class="headerlink" title="创建 auths Maven 模块"></a>创建 auths Maven 模块</h2><p>一个项目有可能有多个业务用户鉴权需求，所有的鉴权都放在这个模块中进行管理。</p><p>接下来我们将以创建 <code>news</code> 业务出发，目录文件结构如下：</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">codezm-auths</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        ├── java</span><br><span class="line">        │&nbsp;&nbsp; └── com</span><br><span class="line">        │&nbsp;&nbsp;     └── codezm</span><br><span class="line">        │&nbsp;&nbsp;         └── auths</span><br><span class="line">        │&nbsp;&nbsp;             └── news</span><br><span class="line">        │&nbsp;&nbsp;                 ├── config</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── NewsSecurityConfig.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; └── properties</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp;     └── PermitAllUrlProperties.java</span><br><span class="line">        │&nbsp;&nbsp;                 ├── constant</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; └── CacheConstants.java</span><br><span class="line">        │&nbsp;&nbsp;                 ├── domain</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── NewsLoginBody.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── NewsLoginUser.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; └── NewsUser.java</span><br><span class="line">        │&nbsp;&nbsp;                 ├── manager</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── AsyncManager.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; └── factory</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp;     └── AsyncFactory.java</span><br><span class="line">        │&nbsp;&nbsp;                 ├── mapper</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; └── LoginUserMapper.java</span><br><span class="line">        │&nbsp;&nbsp;                 ├── security</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── UserPwdAuthenticationProvider.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── UserPwdAuthenticationToken.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── context</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; │&nbsp;&nbsp; ├── AuthenticationContextHolder.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; │&nbsp;&nbsp; └── PermissionContextHolder.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── filter</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; │&nbsp;&nbsp; └── JwtAuthenticationTokenFilter.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; └── handle</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp;     ├── AuthenticationEntryPointImpl.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp;     └── LogoutSuccessHandlerImpl.java</span><br><span class="line">        │&nbsp;&nbsp;                 ├── service</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── ILoginUserService.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── LoginService.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── TokenService.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; ├── UserPwdServiceImpl.java</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp; └── impl</span><br><span class="line">        │&nbsp;&nbsp;                 │&nbsp;&nbsp;     └── LoginUserServiceImpl.java</span><br><span class="line">        │&nbsp;&nbsp;                 └── untils</span><br><span class="line">        │&nbsp;&nbsp;                     └── SecurityUtils.java</span><br><span class="line">        └── resources</span><br><span class="line">            └── mapper</span><br><span class="line">                └── news</span><br><span class="line">                    └── LoginUserMapper.xml</span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/config/NewsSecurityConfig.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.config.properties.PermitAllUrlProperties;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.security.UserPwdAuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.security.filter.JwtAuthenticationTokenFilter;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.security.handle.AuthenticationEntryPointImpl;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.security.handle.LogoutSuccessHandlerImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.logout.LogoutFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.CorsFilter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * spring security配置</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span></span><br><span class="line"><span class="comment">//@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@Order(1)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 系统前台用户身份认证逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier("NewsUserPwdServiceImpl")</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userPwdService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证失败处理类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier("NewsAuthenticationEntryPointImpl")</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationEntryPointImpl unauthorizedHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退出处理类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier("NewsLogoutSuccessHandlerImpl")</span></span><br><span class="line">    <span class="keyword">private</span> LogoutSuccessHandlerImpl logoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token认证过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier("NewsJwtAuthenticationTokenFilter")</span></span><br><span class="line">    <span class="keyword">private</span> JwtAuthenticationTokenFilter authenticationTokenFilter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跨域过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CorsFilter corsFilter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 允许匿名访问的地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier("NewsPermitAllUrlProperties")</span></span><br><span class="line">    <span class="keyword">private</span> PermitAllUrlProperties permitAllUrl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解决 无法直接注入 AuthenticationManager</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean("NewsAuthenticationManager")</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * anyRequest          |   匹配所有请求路径</span></span><br><span class="line"><span class="comment">     * access              |   SpringEl表达式结果为true时可以访问</span></span><br><span class="line"><span class="comment">     * anonymous           |   匿名可以访问</span></span><br><span class="line"><span class="comment">     * denyAll             |   用户不能访问</span></span><br><span class="line"><span class="comment">     * fullyAuthenticated  |   用户完全认证可以访问（非remember-me下自动登录）</span></span><br><span class="line"><span class="comment">     * hasAnyAuthority     |   如果有参数，参数表示权限，则其中任何一个权限可以访问</span></span><br><span class="line"><span class="comment">     * hasAnyRole          |   如果有参数，参数表示角色，则其中任何一个角色可以访问</span></span><br><span class="line"><span class="comment">     * hasAuthority        |   如果有参数，参数表示权限，则其权限可以访问</span></span><br><span class="line"><span class="comment">     * hasIpAddress        |   如果有参数，参数表示IP地址，如果用户IP和参数匹配，则可以访问</span></span><br><span class="line"><span class="comment">     * hasRole             |   如果有参数，参数表示角色，则其角色可以访问</span></span><br><span class="line"><span class="comment">     * permitAll           |   用户可以任意访问</span></span><br><span class="line"><span class="comment">     * rememberMe          |   允许通过remember-me登录的用户访问</span></span><br><span class="line"><span class="comment">     * authenticated       |   用户登录后可访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="comment">// 注解标记允许匿名访问的url</span></span><br><span class="line">        ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry registry = httpSecurity.authorizeRequests();</span><br><span class="line">        permitAllUrl.getUrls().forEach(url -&gt; registry.antMatchers(url).permitAll());</span><br><span class="line"></span><br><span class="line">        httpSecurity</span><br><span class="line">                .requestMatchers((request) -&gt; {</span><br><span class="line">                    request.antMatchers(<span class="string">"/news/**"</span>);</span><br><span class="line">                })</span><br><span class="line">                <span class="comment">// CSRF禁用，因为不使用session</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line">                <span class="comment">// 禁用HTTP响应标头</span></span><br><span class="line">                .headers().cacheControl().disable().and()</span><br><span class="line">                <span class="comment">// 认证失败处理类</span></span><br><span class="line">                .exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and()</span><br><span class="line">                <span class="comment">// 基于token，所以不需要session</span></span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()</span><br><span class="line">                <span class="comment">// 过滤请求</span></span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">// 对于登录login 注册register 验证码captchaImage 允许匿名访问</span></span><br><span class="line">                .antMatchers(<span class="string">"/news/login"</span>, <span class="string">"/news/register"</span>, <span class="string">"/news/captchaImage"</span>).anonymous()</span><br><span class="line">                <span class="comment">// 静态资源，可匿名访问</span></span><br><span class="line"><span class="comment">//                .antMatchers(HttpMethod.GET, "/", "/*.html", "/**/*.html", "/**/*.css", "/**/*.js", "/profile/**","/static/**").permitAll()</span></span><br><span class="line"><span class="comment">//                .antMatchers("/swagger-ui.html", "/swagger-resources/**", "/webjars/**", "/*/api-docs", "/druid/**").permitAll()</span></span><br><span class="line">                <span class="comment">// 除上面外的所有请求全部需要鉴权认证</span></span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .headers().frameOptions().disable();</span><br><span class="line">        <span class="comment">// 添加Logout filter</span></span><br><span class="line">        httpSecurity.logout().logoutUrl(<span class="string">"/news/logout"</span>).logoutSuccessHandler(logoutSuccessHandler);</span><br><span class="line">        <span class="comment">// 添加JWT filter</span></span><br><span class="line">        httpSecurity.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">        <span class="comment">// 添加CORS filter</span></span><br><span class="line">        httpSecurity.addFilterBefore(corsFilter, JwtAuthenticationTokenFilter.class);</span><br><span class="line">        httpSecurity.addFilterBefore(corsFilter, LogoutFilter.class);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 身份认证接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        UserPwdAuthenticationProvider userPwdAuthenticationProvider = <span class="keyword">new</span> UserPwdAuthenticationProvider();</span><br><span class="line">        userPwdAuthenticationProvider.setUserDetailsService(userPwdService);</span><br><span class="line">        auth.authenticationProvider(userPwdAuthenticationProvider);</span><br><span class="line">        auth.userDetailsService(userPwdService).passwordEncoder(<span class="keyword">new</span> BCryptPasswordEncoder());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/config/properties/PermitAllUrlProperties.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.config.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.annotation.Anonymous;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.RegExUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AnnotationUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.HandlerMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置Anonymous注解允许匿名访问的url</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component("NewsPermitAllUrlProperties")</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermitAllUrlProperties</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">ApplicationContextAware</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PATTERN = Pattern.compile(<span class="string">"\\{(.*?)\\}"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; urls = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String ASTERISK = <span class="string">"*"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        RequestMappingHandlerMapping mapping = applicationContext.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">        Map&lt;RequestMappingInfo, HandlerMethod&gt; map = mapping.getHandlerMethods();</span><br><span class="line"></span><br><span class="line">        map.keySet().forEach(info -&gt; {</span><br><span class="line">            HandlerMethod handlerMethod = map.get(info);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取方法上边的注解 替代path variable 为 *</span></span><br><span class="line">            Anonymous method = AnnotationUtils.findAnnotation(handlerMethod.getMethod(), Anonymous.class);</span><br><span class="line">            Optional.ofNullable(method).ifPresent(anonymous -&gt; Objects.requireNonNull(info.getPatternsCondition().getPatterns())</span><br><span class="line">                    .forEach(url -&gt; urls.add(RegExUtils.replaceAll(url, PATTERN, ASTERISK))));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取类上边的注解, 替代path variable 为 *</span></span><br><span class="line">            Anonymous controller = AnnotationUtils.findAnnotation(handlerMethod.getBeanType(), Anonymous.class);</span><br><span class="line">            Optional.ofNullable(controller).ifPresent(anonymous -&gt; Objects.requireNonNull(info.getPatternsCondition().getPatterns())</span><br><span class="line">                    .forEach(url -&gt; urls.add(RegExUtils.replaceAll(url, PATTERN, ASTERISK))));</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext context)</span> <span class="keyword">throws</span> BeansException</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = context;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getUrls</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> urls;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUrls</span><span class="params">(List&lt;String&gt; urls)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.urls = urls;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/constant/CacheConstants.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.constant;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓存的key 常量</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConstants</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录用户 redis key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOGIN_TOKEN_KEY = <span class="string">"login_tokens_news:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码 redis key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CAPTCHA_CODE_KEY = <span class="string">"captcha_codes:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参数管理 cache key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYS_CONFIG_KEY = <span class="string">"sys_config:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字典管理 cache key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYS_DICT_KEY = <span class="string">"sys_dict:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 防重提交 redis key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REPEAT_SUBMIT_KEY = <span class="string">"repeat_submit:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 限流 redis key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RATE_LIMIT_KEY = <span class="string">"rate_limit:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录账户密码错误次数 redis key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PWD_ERR_CNT_KEY = <span class="string">"pwd_err_cnt:"</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/domain/NewsLoginBody.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.domain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户登录对象</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsLoginBody</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 唯一标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(String code)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUuid</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> uuid;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUuid</span><span class="params">(String uuid)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.uuid = uuid;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/domain/NewsLoginUser.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.annotation.JSONField;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsUser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录用户身份权限</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsLoginUser</span> <span class="keyword">implements</span> <span class="title">UserDetails</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 部门ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long deptId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * openId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String openId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户唯一标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long loginTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过期时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long expireTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录IP地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String ipaddr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录地点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String loginLocation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 浏览器类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String browser;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作系统</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String os;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 权限列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; permissions;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> NewsUser newsUser;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewsLoginUser</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewsLoginUser</span><span class="params">(NewsUser newsUser, Set&lt;String&gt; permissions)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.newsUser = newsUser;</span><br><span class="line">        <span class="keyword">this</span>.permissions = permissions;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NewsLoginUser</span><span class="params">(Long userId, Long deptId, NewsUser newsUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">        <span class="keyword">this</span>.deptId = deptId;</span><br><span class="line">        <span class="keyword">this</span>.newsUser = newsUser;</span><br><span class="line">        <span class="comment">//this.permissions = permissions;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getUserId</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getDeptId</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> deptId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDeptId</span><span class="params">(Long deptId)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.deptId = deptId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getToken</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setToken</span><span class="params">(String token)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.token = token;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOpenId</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> openId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOpenId</span><span class="params">(String openId)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.openId = openId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JSONField(serialize = false)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> newsUser.getPassword();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> newsUser.getUserName();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账户是否未过期,过期无法验证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JSONField(serialize = false)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定用户是否解锁,锁定的用户无法进行身份验证</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JSONField(serialize = false)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指示是否已过期的用户的凭据(密码),过期的凭据防止认证</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JSONField(serialize = false)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否可用 ,禁用的用户不能身份验证</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JSONField(serialize = false)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getLoginTime</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginTime;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginTime</span><span class="params">(Long loginTime)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.loginTime = loginTime;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIpaddr</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> ipaddr;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIpaddr</span><span class="params">(String ipaddr)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.ipaddr = ipaddr;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLoginLocation</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginLocation;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginLocation</span><span class="params">(String loginLocation)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.loginLocation = loginLocation;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBrowser</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> browser;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBrowser</span><span class="params">(String browser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.browser = browser;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOs</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> os;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOs</span><span class="params">(String os)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.os = os;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getExpireTime</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> expireTime;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExpireTime</span><span class="params">(Long expireTime)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.expireTime = expireTime;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getPermissions</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> permissions;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPermissions</span><span class="params">(Set&lt;String&gt; permissions)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.permissions = permissions;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NewsUser <span class="title">getUser</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> newsUser;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUser</span><span class="params">(NewsUser newsUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.newsUser = newsUser;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities()</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/domain/NewsUser.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.BaseEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.builder.ToStringBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.builder.ToStringStyle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户信息对象 news_user</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024-03-05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsUser</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用户ID */</span></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 部门ID */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "部门ID")</span></span><br><span class="line">    <span class="keyword">private</span> Long deptId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用户账号 */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "用户账号")</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用户昵称 */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "用户昵称")</span></span><br><span class="line">    <span class="keyword">private</span> String nickName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用户类型（00系统用户） */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "用户类型", readConverterExp = "0=0系统用户")</span></span><br><span class="line">    <span class="keyword">private</span> String userType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用户邮箱 */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "用户邮箱")</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 手机号码 */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "手机号码")</span></span><br><span class="line">    <span class="keyword">private</span> String phonenumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用户性别（0男 1女 2未知） */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "用户性别", readConverterExp = "0=男,1=女,2=未知")</span></span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 头像地址 */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "头像地址")</span></span><br><span class="line">    <span class="keyword">private</span> String avatar;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 密码 */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "密码")</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 帐号状态（0正常 1停用） */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "帐号状态", readConverterExp = "0=正常,1=停用")</span></span><br><span class="line">    <span class="keyword">private</span> String status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 删除标志（0代表存在 2代表删除） */</span></span><br><span class="line">    <span class="keyword">private</span> String delFlag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 最后登录IP */</span></span><br><span class="line"><span class="comment">//    @Excel(name = "最后登录IP")</span></span><br><span class="line">    <span class="keyword">private</span> String loginIp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 最后登录时间 */</span></span><br><span class="line"><span class="comment">//    @JsonFormat(pattern = "yyyy-MM-dd")</span></span><br><span class="line"><span class="comment">//    @Excel(name = "最后登录时间", width = 30, dateFormat = "yyyy-MM-dd")</span></span><br><span class="line">    <span class="keyword">private</span> Date loginDate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">(Long userId)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getUserId</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDeptId</span><span class="params">(Long deptId)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.deptId = deptId;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getDeptId</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> deptId;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNickName</span><span class="params">(String nickName)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.nickName = nickName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNickName</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> nickName;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserType</span><span class="params">(String userType)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.userType = userType;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserType</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> userType;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPhonenumber</span><span class="params">(String phonenumber)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.phonenumber = phonenumber;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPhonenumber</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> phonenumber;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAvatar</span><span class="params">(String avatar)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.avatar = avatar;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAvatar</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> avatar;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStatus</span><span class="params">(String status)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.status = status;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getStatus</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDelFlag</span><span class="params">(String delFlag)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.delFlag = delFlag;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDelFlag</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> delFlag;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginIp</span><span class="params">(String loginIp)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.loginIp = loginIp;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLoginIp</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginIp;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginDate</span><span class="params">(Date loginDate)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">this</span>.loginDate = loginDate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getLoginDate</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginDate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ToStringBuilder(<span class="keyword">this</span>,ToStringStyle.MULTI_LINE_STYLE)</span><br><span class="line">            .append(<span class="string">"userId"</span>, getUserId())</span><br><span class="line">            .append(<span class="string">"deptId"</span>, getDeptId())</span><br><span class="line">            .append(<span class="string">"userName"</span>, getUserName())</span><br><span class="line">            .append(<span class="string">"nickName"</span>, getNickName())</span><br><span class="line">            .append(<span class="string">"userType"</span>, getUserType())</span><br><span class="line">            .append(<span class="string">"email"</span>, getEmail())</span><br><span class="line">            .append(<span class="string">"phonenumber"</span>, getPhonenumber())</span><br><span class="line">            .append(<span class="string">"sex"</span>, getSex())</span><br><span class="line">            .append(<span class="string">"avatar"</span>, getAvatar())</span><br><span class="line">            .append(<span class="string">"password"</span>, getPassword())</span><br><span class="line">            .append(<span class="string">"status"</span>, getStatus())</span><br><span class="line">            .append(<span class="string">"delFlag"</span>, getDelFlag())</span><br><span class="line">            .append(<span class="string">"loginIp"</span>, getLoginIp())</span><br><span class="line">            .append(<span class="string">"loginDate"</span>, getLoginDate())</span><br><span class="line">            .append(<span class="string">"createBy"</span>, getCreateBy())</span><br><span class="line">            .append(<span class="string">"createTime"</span>, getCreateTime())</span><br><span class="line">            .append(<span class="string">"updateBy"</span>, getUpdateBy())</span><br><span class="line">            .append(<span class="string">"updateTime"</span>, getUpdateTime())</span><br><span class="line">            .append(<span class="string">"remark"</span>, getRemark())</span><br><span class="line">            .toString();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/manager/factory/AsyncFactory.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.manager.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.LogUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ip.AddressUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ip.IpUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.spring.SpringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.system.domain.SysLogininfor;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.system.domain.SysOperLog;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.system.service.ISysLogininforService;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.system.service.ISysOperLogService;</span><br><span class="line"><span class="keyword">import</span> eu.bitwalker.useragentutils.UserAgent;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.TimerTask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 异步工厂（产生任务用）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncFactory</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger sys_user_logger = LoggerFactory.getLogger(<span class="string">"sys-user"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录登录信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status 状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args 列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 任务task</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TimerTask <span class="title">recordLogininfor</span><span class="params">(<span class="keyword">final</span> String username, <span class="keyword">final</span> String status, <span class="keyword">final</span> String message,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> Object... args)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">final</span> UserAgent userAgent = UserAgent.parseUserAgentString(ServletUtils.getRequest().getHeader(<span class="string">"User-Agent"</span>));</span><br><span class="line">        <span class="keyword">final</span> String ip = IpUtils.getIpAddr(ServletUtils.getRequest());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TimerTask()</span><br><span class="line">        {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>{</span><br><span class="line">                String address = AddressUtils.getRealAddressByIP(ip);</span><br><span class="line">                StringBuilder s = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                s.append(LogUtils.getBlock(ip));</span><br><span class="line">                s.append(address);</span><br><span class="line">                s.append(LogUtils.getBlock(username));</span><br><span class="line">                s.append(LogUtils.getBlock(status));</span><br><span class="line">                s.append(LogUtils.getBlock(message));</span><br><span class="line">                <span class="comment">// 打印信息到日志</span></span><br><span class="line">                sys_user_logger.info(s.toString(), args);</span><br><span class="line">                <span class="comment">// 获取客户端操作系统</span></span><br><span class="line">                String os = userAgent.getOperatingSystem().getName();</span><br><span class="line">                <span class="comment">// 获取客户端浏览器</span></span><br><span class="line">                String browser = userAgent.getBrowser().getName();</span><br><span class="line">                <span class="comment">// 封装对象</span></span><br><span class="line">                SysLogininfor logininfor = <span class="keyword">new</span> SysLogininfor();</span><br><span class="line">                logininfor.setUserName(username);</span><br><span class="line">                logininfor.setIpaddr(ip);</span><br><span class="line">                logininfor.setLoginLocation(address);</span><br><span class="line">                logininfor.setBrowser(browser);</span><br><span class="line">                logininfor.setOs(os);</span><br><span class="line">                logininfor.setMsg(message);</span><br><span class="line">                <span class="comment">// 日志状态</span></span><br><span class="line">                <span class="keyword">if</span> (StringUtils.equalsAny(status, Constants.LOGIN_SUCCESS, Constants.LOGOUT, Constants.REGISTER))</span><br><span class="line">                {</span><br><span class="line">                    logininfor.setStatus(Constants.SUCCESS);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (Constants.LOGIN_FAIL.equals(status))</span><br><span class="line">                {</span><br><span class="line">                    logininfor.setStatus(Constants.FAIL);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// 插入数据</span></span><br><span class="line">                SpringUtils.getBean(ISysLogininforService.class).insertLogininfor(logininfor);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作日志记录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> operLog 操作日志信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 任务task</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TimerTask <span class="title">recordOper</span><span class="params">(<span class="keyword">final</span> SysOperLog operLog)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TimerTask()</span><br><span class="line">        {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>{</span><br><span class="line">                <span class="comment">// 远程查询操作地点</span></span><br><span class="line">                operLog.setOperLocation(AddressUtils.getRealAddressByIP(operLog.getOperIp()));</span><br><span class="line">                SpringUtils.getBean(ISysOperLogService.class).insertOperlog(operLog);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/manager/AsyncManager.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.manager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.Threads;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.spring.SpringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.TimerTask;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 异步任务管理器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncManager</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 操作延迟10毫秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> OPERATE_DELAY_TIME = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步操作任务调度线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ScheduledExecutorService executor = SpringUtils.getBean(<span class="string">"scheduledExecutorService"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单例模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AsyncManager</span><span class="params">()</span></span>{}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AsyncManager me = <span class="keyword">new</span> AsyncManager();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AsyncManager <span class="title">me</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> me;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task 任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(TimerTask task)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        executor.schedule(task, OPERATE_DELAY_TIME, TimeUnit.MILLISECONDS);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止任务线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        Threads.shutdownAndAwaitTermination(executor);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/mapper/LoginUserMapper.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsUser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户信息Mapper接口</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024-03-05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoginUserMapper</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户信息主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NewsUser <span class="title">selectUserByUserId</span><span class="params">(Long userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName 用户信息主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NewsUser <span class="title">selectUserByUserName</span><span class="params">(String userName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phone 用户信息主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NewsUser <span class="title">selectUserByPhone</span><span class="params">(String phone)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户信息列表</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsUser 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;NewsUser&gt; <span class="title">selectUserList</span><span class="params">(NewsUser newsUser)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 新增用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @param newsUser 用户信息</span></span><br><span class="line"><span class="comment">     * @return 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertUser</span><span class="params">(NewsUser newsUser)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsUser 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateUser</span><span class="params">(NewsUser newsUser)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户信息主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUserByUserId</span><span class="params">(Long userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userIds 需要删除的数据主键集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUserByUserIds</span><span class="params">(Long[] userIds)</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/security/context/AuthenticationContextHolder.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.security.context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 身份验证信息</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationContextHolder</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Authentication&gt; contextHolder = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Authentication <span class="title">getContext</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> contextHolder.get();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setContext</span><span class="params">(Authentication context)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        contextHolder.set(context);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clearContext</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        contextHolder.remove();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/security/context/PermissionContextHolder.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.security.context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 身份验证信息</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationContextHolder</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Authentication&gt; contextHolder = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Authentication <span class="title">getContext</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> contextHolder.get();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setContext</span><span class="params">(Authentication context)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        contextHolder.set(context);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clearContext</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        contextHolder.remove();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/security/filter/JwtAuthenticationTokenFilter.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.security.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsLoginUser;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.service.TokenService;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.untils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * token过滤器 验证token有效性</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component("NewsJwtAuthenticationTokenFilter")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        NewsLoginUser newsLoginUser = tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(newsLoginUser) &amp;&amp; StringUtils.isNull(SecurityUtils.getAuthentication()))</span><br><span class="line">        {</span><br><span class="line">            tokenService.verifyToken(newsLoginUser);</span><br><span class="line">            UsernamePasswordAuthenticationToken authenticationToken = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(newsLoginUser, <span class="keyword">null</span>, newsLoginUser.getAuthorities());</span><br><span class="line">            authenticationToken.setDetails(<span class="keyword">new</span> WebAuthenticationDetailsSource().buildDetails(request));</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line">        }</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/security/handle/AuthenticationEntryPointImpl.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.security.handle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSON;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证失败处理类 返回未授权</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component("NewsAuthenticationEntryPointImpl")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationEntryPointImpl</span> <span class="keyword">implements</span> <span class="title">AuthenticationEntryPoint</span>, <span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8970718410437077606L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">int</span> code = HttpStatus.UNAUTHORIZED;</span><br><span class="line">        String msg = StringUtils.format(<span class="string">"请求访问：{}，认证失败，无法 访问系统资源"</span>, request.getRequestURI());</span><br><span class="line">        ServletUtils.renderString(response, JSON.toJSONString(AjaxResult.error(code, msg)));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/security/handle/LogoutSuccessHandlerImpl.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.security.handle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSON;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsLoginUser;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.manager.AsyncManager;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.manager.factory.AsyncFactory;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.service.TokenService;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.logout.LogoutSuccessHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义退出处理类 返回成功</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component("NewsLogoutSuccessHandlerImpl")</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogoutSuccessHandlerImpl</span> <span class="keyword">implements</span> <span class="title">LogoutSuccessHandler</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退出处理</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        NewsLoginUser newsLoginUser = tokenService.getLoginUser(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(newsLoginUser))</span><br><span class="line">        {</span><br><span class="line">            String userName = newsLoginUser.getUsername();</span><br><span class="line">            <span class="comment">// 删除用户缓存记录</span></span><br><span class="line">            tokenService.delLoginUser(newsLoginUser.getToken());</span><br><span class="line">            <span class="comment">// 记录用户退出日志</span></span><br><span class="line">            AsyncManager.me().execute(AsyncFactory.recordLogininfor(userName, Constants.LOGOUT, <span class="string">"退出成功"</span>));</span><br><span class="line">        }</span><br><span class="line">        ServletUtils.renderString(response, JSON.toJSONString(AjaxResult.success(<span class="string">"退出成功"</span>)));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/security/UserPwdAuthenticationProvider.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserPwdAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">        UserPwdAuthenticationToken authenticationToken = (UserPwdAuthenticationToken) authentication;</span><br><span class="line"></span><br><span class="line">        String userName = (String) authenticationToken.getPrincipal();</span><br><span class="line"></span><br><span class="line">        UserDetails userDetails = userDetailsService.loadUserByUsername(userName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 此时鉴权成功后，应当重新 new 一个拥有鉴权的 authenticationResult 返回</span></span><br><span class="line">        UserPwdAuthenticationToken authenticationResult = <span class="keyword">new</span> UserPwdAuthenticationToken(userDetails, userDetails.getAuthorities());</span><br><span class="line"></span><br><span class="line">        authenticationResult.setDetails(authenticationToken.getDetails());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> authenticationResult;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>{</span><br><span class="line">        <span class="comment">// 判断 authentication 是不是 SmsCodeAuthenticationToken 的子类或子接口</span></span><br><span class="line">        <span class="keyword">return</span> UserPwdAuthenticationToken.class.isAssignableFrom(authentication);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">getUserDetailsService</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> userDetailsService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserDetailsService</span><span class="params">(UserDetailsService userDetailsService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/security/UserPwdAuthenticationToken.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AbstractAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.SpringSecurityCoreVersion;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserPwdAuthenticationToken</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationToken</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在 UsernamePasswordAuthenticationToken 中该字段代表登录的用户名，</span></span><br><span class="line"><span class="comment">     * 在这里就代表登录的手机号码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object principal;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object credentials;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建一个没有鉴权的 SmsCodeAuthenticationToken</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserPwdAuthenticationToken</span><span class="params">(Object principal, Object credentials)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.principal = principal;</span><br><span class="line">        <span class="keyword">this</span>.credentials = credentials;</span><br><span class="line">        setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建拥有鉴权的 SmsCodeAuthenticationToken</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserPwdAuthenticationToken</span><span class="params">(Object principal, Object credentials,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(authorities);</span><br><span class="line">        <span class="keyword">this</span>.principal = principal;</span><br><span class="line">        <span class="keyword">this</span>.credentials = credentials;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">true</span>); <span class="comment">// must use super, as we override</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.credentials;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.principal;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException </span>{</span><br><span class="line">        Assert.isTrue(!isAuthenticated,</span><br><span class="line">                <span class="string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span>);</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eraseCredentials</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.eraseCredentials();</span><br><span class="line">        <span class="keyword">this</span>.credentials = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/service/impl/LoginUserServiceImpl.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsUser;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.mapper.LoginUserMapper;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.service.ILoginUserService;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.service.TokenService;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.DateUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户信息Service业务层处理</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024-03-05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginUserServiceImpl</span> <span class="keyword">implements</span> <span class="title">ILoginUserService</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginUserMapper loginUserMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户信息主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NewsUser <span class="title">selectUserByUserId</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.selectUserByUserId(userId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户信息列表</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsUser 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;NewsUser&gt; <span class="title">selectUserList</span><span class="params">(NewsUser newsUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.selectUserList(newsUser);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过用户名查询用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户对象信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NewsUser <span class="title">selectUserByUserName</span><span class="params">(String userName)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.selectUserByUserName(userName);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsUser 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertUser</span><span class="params">(NewsUser newsUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        newsUser.setCreateTime(DateUtils.getNowDate());</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.insertUser(newsUser);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsUser 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateUser</span><span class="params">(NewsUser newsUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        newsUser.setUpdateTime(DateUtils.getNowDate());</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.updateUser(newsUser);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userIds 需要删除的用户信息主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUserByUserIds</span><span class="params">(Long[] userIds)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.deleteUserByUserIds(userIds);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户信息信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户信息主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUserByUserId</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.deleteUserByUserId(userId);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/service/ILoginUserService.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsUser;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.mapper.LoginUserMapper;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.service.ILoginUserService;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.service.TokenService;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.DateUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户信息Service业务层处理</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024-03-05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginUserServiceImpl</span> <span class="keyword">implements</span> <span class="title">ILoginUserService</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginUserMapper loginUserMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户信息主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NewsUser <span class="title">selectUserByUserId</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.selectUserByUserId(userId);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户信息列表</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsUser 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;NewsUser&gt; <span class="title">selectUserList</span><span class="params">(NewsUser newsUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.selectUserList(newsUser);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过用户名查询用户</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户对象信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NewsUser <span class="title">selectUserByUserName</span><span class="params">(String userName)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.selectUserByUserName(userName);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsUser 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertUser</span><span class="params">(NewsUser newsUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        newsUser.setCreateTime(DateUtils.getNowDate());</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.insertUser(newsUser);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsUser 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateUser</span><span class="params">(NewsUser newsUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        newsUser.setUpdateTime(DateUtils.getNowDate());</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.updateUser(newsUser);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除用户信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userIds 需要删除的用户信息主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUserByUserIds</span><span class="params">(Long[] userIds)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.deleteUserByUserIds(userIds);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户信息信息</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户信息主键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteUserByUserId</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> loginUserMapper.deleteUserByUserId(userId);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/service/LoginService.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.constant.CacheConstants;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsUser;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsLoginUser;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.manager.AsyncManager;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.manager.factory.AsyncFactory;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.security.context.AuthenticationContextHolder;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.UserConstants;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.redis.RedisCache;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.exception.ServiceException;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.exception.user.*;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.DateUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ip.IpUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.system.service.ISysConfigService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.BadCredentialsException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.MessageUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component("NewsLoginService")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier("NewsTokenService")</span></span><br><span class="line">    <span class="keyword">private</span> TokenService tokenService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ISysConfigService configService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier("NewsAuthenticationManager")</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisCache redisCache;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ILoginUserService loginUserService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录验证</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password 密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code 验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uuid 唯一标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(String username, String password, String code, String uuid)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="comment">// 验证码校验</span></span><br><span class="line">        validateCaptcha(username, code, uuid);</span><br><span class="line">        <span class="comment">// 登录前置校验</span></span><br><span class="line">        loginPreCheck(username, password);</span><br><span class="line">        <span class="comment">// 用户验证</span></span><br><span class="line">        Authentication authentication = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        {</span><br><span class="line">            UsernamePasswordAuthenticationToken authenticationToken = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(username, password);</span><br><span class="line">            AuthenticationContextHolder.setContext(authenticationToken);</span><br><span class="line">            <span class="comment">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername</span></span><br><span class="line">            authentication = authenticationManager.authenticate(authenticationToken);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BadCredentialsException)</span><br><span class="line">            {</span><br><span class="line">                AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message(<span class="string">"user.password.not.match"</span>)));</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UserPasswordNotMatchException();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            {</span><br><span class="line">                AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, e.getMessage()));</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(e.getMessage());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        {</span><br><span class="line">            AuthenticationContextHolder.clearContext();</span><br><span class="line">        }</span><br><span class="line">        AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_SUCCESS, MessageUtils.message(<span class="string">"user.login.success"</span>)));</span><br><span class="line">        NewsLoginUser newsLoginUser = (NewsLoginUser) authentication.getPrincipal();</span><br><span class="line">        recordLoginInfo(newsLoginUser.getUserId());</span><br><span class="line">        <span class="comment">// 生成token</span></span><br><span class="line">        <span class="keyword">return</span> tokenService.createToken(newsLoginUser);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验验证码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code 验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uuid 唯一标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validateCaptcha</span><span class="params">(String username, String code, String uuid)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">boolean</span> captchaEnabled = configService.selectCaptchaOnOff();</span><br><span class="line">        <span class="keyword">if</span> (captchaEnabled)</span><br><span class="line">        {</span><br><span class="line">            String verifyKey = CacheConstants.CAPTCHA_CODE_KEY + StringUtils.nvl(uuid, <span class="string">""</span>);</span><br><span class="line">            String captcha = redisCache.getCacheObject(verifyKey);</span><br><span class="line">            redisCache.deleteObject(verifyKey);</span><br><span class="line">            <span class="keyword">if</span> (captcha == <span class="keyword">null</span>)</span><br><span class="line">            {</span><br><span class="line">                AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message(<span class="string">"user.jcaptcha.expire"</span>)));</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> CaptchaExpireException();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (!code.equalsIgnoreCase(captcha))</span><br><span class="line">            {</span><br><span class="line">                AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message(<span class="string">"user.jcaptcha.error"</span>)));</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> CaptchaException();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录前置校验</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password 用户密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loginPreCheck</span><span class="params">(String username, String password)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="comment">// 用户名或密码为空 错误</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(username) || StringUtils.isEmpty(password))</span><br><span class="line">        {</span><br><span class="line">            AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message(<span class="string">"not.null"</span>)));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UserNotExistsException();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 密码如果不在指定范围内 错误</span></span><br><span class="line">        <span class="keyword">if</span> (password.length() &lt; UserConstants.PASSWORD_MIN_LENGTH</span><br><span class="line">                || password.length() &gt; UserConstants.PASSWORD_MAX_LENGTH)</span><br><span class="line">        {</span><br><span class="line">            AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message(<span class="string">"user.password.not.match"</span>)));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UserPasswordNotMatchException();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 用户名不在指定范围内 错误</span></span><br><span class="line">        <span class="keyword">if</span> (username.length() &lt; UserConstants.USERNAME_MIN_LENGTH</span><br><span class="line">                || username.length() &gt; UserConstants.USERNAME_MAX_LENGTH)</span><br><span class="line">        {</span><br><span class="line">            AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_FAIL, MessageUtils.message(<span class="string">"user.password.not.match"</span>)));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UserPasswordNotMatchException();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录登录信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordLoginInfo</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        NewsUser newsUser = <span class="keyword">new</span> NewsUser();</span><br><span class="line">        newsUser.setUserId(userId);</span><br><span class="line">        newsUser.setLoginIp(IpUtils.getIpAddr(ServletUtils.getRequest()));</span><br><span class="line">        newsUser.setLoginDate(DateUtils.getNowDate());</span><br><span class="line">        loginUserService.updateUser(newsUser);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/service/TokenService.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.constant.CacheConstants;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsLoginUser;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.redis.RedisCache;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ip.AddressUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.ip.IpUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.uuid.IdUtils;</span><br><span class="line"><span class="keyword">import</span> eu.bitwalker.useragentutils.UserAgent;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * token验证处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component("NewsTokenService")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenService</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="comment">// 令牌自定义标识</span></span><br><span class="line">    <span class="meta">@Value("${news.token.header}")</span></span><br><span class="line">    <span class="keyword">private</span> String header;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 令牌秘钥</span></span><br><span class="line">    <span class="meta">@Value("${news.token.secret}")</span></span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 令牌有效期（默认30分钟）</span></span><br><span class="line">    <span class="meta">@Value("${news.token.expireTime}")</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expireTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MILLIS_SECOND = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MILLIS_MINUTE = <span class="number">60</span> * MILLIS_SECOND;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Long MILLIS_MINUTE_TEN = <span class="number">20</span> * <span class="number">60</span> * <span class="number">1000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisCache redisCache;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户身份信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NewsLoginUser <span class="title">getLoginUser</span><span class="params">(HttpServletRequest request)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        String token = getToken(request);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(token))</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            {</span><br><span class="line">                Claims claims = parseToken(token);</span><br><span class="line">                <span class="comment">// 解析对应的权限以及用户信息</span></span><br><span class="line">                String uuid = (String) claims.get(Constants.LOGIN_USER_KEY);</span><br><span class="line">                String userKey = getTokenKey(uuid);</span><br><span class="line">                NewsLoginUser user = redisCache.getCacheObject(userKey);</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            {</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置用户身份信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginUser</span><span class="params">(NewsLoginUser newsLoginUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotNull(newsLoginUser) &amp;&amp; StringUtils.isNotEmpty(newsLoginUser.getToken()))</span><br><span class="line">        {</span><br><span class="line">            refreshToken(newsLoginUser);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户身份信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delLoginUser</span><span class="params">(String token)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(token))</span><br><span class="line">        {</span><br><span class="line">            String userKey = getTokenKey(token);</span><br><span class="line">            redisCache.deleteObject(userKey);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建令牌</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsLoginUser 用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createToken</span><span class="params">(NewsLoginUser newsLoginUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        String token = IdUtils.fastUUID();</span><br><span class="line">        newsLoginUser.setToken(token);</span><br><span class="line">        setUserAgent(newsLoginUser);</span><br><span class="line">        refreshToken(newsLoginUser);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        claims.put(Constants.LOGIN_USER_KEY, token);</span><br><span class="line">        <span class="keyword">return</span> createToken(claims);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证令牌有效期，相差不足20分钟，自动刷新缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsLoginUser</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifyToken</span><span class="params">(NewsLoginUser newsLoginUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">long</span> expireTime = newsLoginUser.getExpireTime();</span><br><span class="line">        <span class="keyword">long</span> currentTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (expireTime - currentTime &lt;= MILLIS_MINUTE_TEN)</span><br><span class="line">        {</span><br><span class="line">            refreshToken(newsLoginUser);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 刷新令牌有效期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsLoginUser 登录信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshToken</span><span class="params">(NewsLoginUser newsLoginUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        newsLoginUser.setLoginTime(System.currentTimeMillis());</span><br><span class="line">        newsLoginUser.setExpireTime(newsLoginUser.getLoginTime() + expireTime * MILLIS_MINUTE);</span><br><span class="line">        <span class="comment">// 根据uuid将loginUser缓存</span></span><br><span class="line">        String userKey = getTokenKey(newsLoginUser.getToken());</span><br><span class="line">        redisCache.setCacheObject(userKey, newsLoginUser, expireTime, TimeUnit.MINUTES);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置用户代理信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newsLoginUser 登录信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserAgent</span><span class="params">(NewsLoginUser newsLoginUser)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        UserAgent userAgent = UserAgent.parseUserAgentString(ServletUtils.getRequest().getHeader(<span class="string">"User-Agent"</span>));</span><br><span class="line">        String ip = IpUtils.getIpAddr(ServletUtils.getRequest());</span><br><span class="line">        newsLoginUser.setIpaddr(ip);</span><br><span class="line">        newsLoginUser.setLoginLocation(AddressUtils.getRealAddressByIP(ip));</span><br><span class="line">        newsLoginUser.setBrowser(userAgent.getBrowser().getName());</span><br><span class="line">        newsLoginUser.setOs(userAgent.getOperatingSystem().getName());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从数据声明生成令牌</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> claims 数据声明</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">createToken</span><span class="params">(Map&lt;String, Object&gt; claims)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        String token = Jwts.builder()</span><br><span class="line">                .setClaims(claims)</span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, secret).compact();</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从令牌中获取数据声明</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token 令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据声明</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Claims <span class="title">parseToken</span><span class="params">(String token)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(secret)</span><br><span class="line">                .parseClaimsJws(token)</span><br><span class="line">                .getBody();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从令牌中获取用户名</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token 令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsernameFromToken</span><span class="params">(String token)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        Claims claims = parseToken(token);</span><br><span class="line">        <span class="keyword">return</span> claims.getSubject();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取请求token</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getToken</span><span class="params">(HttpServletRequest request)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        String token = request.getHeader(header);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(token) &amp;&amp; token.startsWith(Constants.TOKEN_PREFIX))</span><br><span class="line">        {</span><br><span class="line">            token = token.replace(Constants.TOKEN_PREFIX, <span class="string">""</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getTokenKey</span><span class="params">(String uuid)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> CacheConstants.LOGIN_TOKEN_KEY + uuid;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/service/UserPwdServiceImpl.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsUser;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsLoginUser;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.enums.UserStatus;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.exception.ServiceException;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.utils.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service("NewsUserPwdServiceImpl")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserPwdServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(UserPwdServiceImpl.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ILoginUserService loginUserService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>{</span><br><span class="line">        NewsUser newsUser = loginUserService.selectUserByUserName(username);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNull(newsUser)) {</span><br><span class="line">            log.info(<span class="string">"登录用户：{} 不存在."</span>, username);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(<span class="string">"登录用户："</span> + username + <span class="string">" 不存在"</span>);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (UserStatus.DELETED.getCode().equals(newsUser.getDelFlag())) {</span><br><span class="line">            log.info(<span class="string">"登录用户：{} 已被删除."</span>, username);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(<span class="string">"对不起，您的账号："</span> + username + <span class="string">" 已被删除"</span>);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (UserStatus.DISABLE.getCode().equals(newsUser.getStatus())) {</span><br><span class="line">            log.info(<span class="string">"登录用户：{} 已被停用."</span>, username);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(<span class="string">"对不起，您的账号："</span> + username + <span class="string">" 未激活"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> createLoginUser(newsUser);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">createLoginUser</span><span class="params">(NewsUser newsUser)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NewsLoginUser(newsUser.getUserId(), newsUser.getDeptId(), newsUser);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>auths/src/main/java/com/codezm/auths/news/untils/SecurityUtils.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.auths.news.untils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.NewsLoginUser;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.exception.ServiceException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 安全服务工具类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityUtils</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户ID</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">getUserId</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">return</span> getLoginUser().getUserId();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(<span class="string">"获取用户ID异常"</span>, HttpStatus.UNAUTHORIZED);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户OpenId</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getOpenId</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">return</span> getLoginUser().getOpenId();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(<span class="string">"获取用户OpenId异常"</span>, HttpStatus.UNAUTHORIZED);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取部门ID</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">getDeptId</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">return</span> getLoginUser().getDeptId();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(<span class="string">"获取部门ID异常"</span>, HttpStatus.UNAUTHORIZED);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户账户</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUsername</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">return</span> getLoginUser().getUsername();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(<span class="string">"获取用户账户异常"</span>, HttpStatus.UNAUTHORIZED);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NewsLoginUser <span class="title">getLoginUser</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">return</span> (NewsLoginUser) getAuthentication().getPrincipal();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(<span class="string">"获取用户信息异常"</span>, HttpStatus.UNAUTHORIZED);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Authentication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Authentication <span class="title">getAuthentication</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成BCryptPasswordEncoder密码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password 密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encryptPassword</span><span class="params">(String password)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        BCryptPasswordEncoder passwordEncoder = <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">        <span class="keyword">return</span> passwordEncoder.encode(password);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断密码是否相同</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rawPassword 真实密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encodedPassword 加密后字符</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">matchesPassword</span><span class="params">(String rawPassword, String encodedPassword)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        BCryptPasswordEncoder passwordEncoder = <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">        <span class="keyword">return</span> passwordEncoder.matches(rawPassword, encodedPassword);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否为管理员</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAdmin</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> userId != <span class="keyword">null</span> &amp;&amp; <span class="number">1L</span> == userId;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>/auths/src/main/resources/mapper/news/LoginUserMapper.xml</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">PUBLIC <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.codezm.auths.news.mapper.LoginUserMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"NewsUser"</span> <span class="attr">id</span>=<span class="string">"UserResult"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userId"</span>    <span class="attr">column</span>=<span class="string">"user_id"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"deptId"</span>    <span class="attr">column</span>=<span class="string">"dept_id"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userName"</span>    <span class="attr">column</span>=<span class="string">"user_name"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"nickName"</span>    <span class="attr">column</span>=<span class="string">"nick_name"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"userType"</span>    <span class="attr">column</span>=<span class="string">"user_type"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"email"</span>    <span class="attr">column</span>=<span class="string">"email"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"phonenumber"</span>    <span class="attr">column</span>=<span class="string">"phonenumber"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sex"</span>    <span class="attr">column</span>=<span class="string">"sex"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"avatar"</span>    <span class="attr">column</span>=<span class="string">"avatar"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"password"</span>    <span class="attr">column</span>=<span class="string">"password"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"status"</span>    <span class="attr">column</span>=<span class="string">"status"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"delFlag"</span>    <span class="attr">column</span>=<span class="string">"del_flag"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"loginIp"</span>    <span class="attr">column</span>=<span class="string">"login_ip"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"loginDate"</span>    <span class="attr">column</span>=<span class="string">"login_date"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"createBy"</span>    <span class="attr">column</span>=<span class="string">"create_by"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"createTime"</span>    <span class="attr">column</span>=<span class="string">"create_time"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"updateBy"</span>    <span class="attr">column</span>=<span class="string">"update_by"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"updateTime"</span>    <span class="attr">column</span>=<span class="string">"update_time"</span>    /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"remark"</span>    <span class="attr">column</span>=<span class="string">"remark"</span>    /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"selectUserVo"</span>&gt;</span></span><br><span class="line">        select user_id, dept_id, user_name, nick_name, user_type, email, phonenumber, sex, avatar, password, status, del_flag, login_ip, login_date, create_by, create_time, update_by, update_time, remark from news_user</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserList"</span> <span class="attr">parameterType</span>=<span class="string">"NewsUser"</span> <span class="attr">resultMap</span>=<span class="string">"UserResult"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"selectUserVo"</span>/&gt;</span></span><br><span class="line">        where del_flag='0'</span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"deptId != null "</span>&gt;</span> and dept_id = #{deptId}<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null  and userName != ''"</span>&gt;</span> and user_name like concat('%', #{userName}, '%')<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"nickName != null  and nickName != ''"</span>&gt;</span> and nick_name like concat('%', #{nickName}, '%')<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userType != null  and userType != ''"</span>&gt;</span> and user_type = #{userType}<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"email != null  and email != ''"</span>&gt;</span> and email = #{email}<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"phonenumber != null  and phonenumber != ''"</span>&gt;</span> and phonenumber = #{phonenumber}<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"sex != null  and sex != ''"</span>&gt;</span> and sex = #{sex}<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"avatar != null  and avatar != ''"</span>&gt;</span> and avatar = #{avatar}<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"password != null  and password != ''"</span>&gt;</span> and password = #{password}<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null  and status != ''"</span>&gt;</span> and status = #{status}<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"loginIp != null  and loginIp != ''"</span>&gt;</span> and login_ip = #{loginIp}<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"loginDate != null "</span>&gt;</span> and login_date = #{loginDate}<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserByUserId"</span> <span class="attr">parameterType</span>=<span class="string">"Long"</span> <span class="attr">resultMap</span>=<span class="string">"UserResult"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"selectUserVo"</span>/&gt;</span></span><br><span class="line">        where user_id = #{userId} and del_flag = '0' limit 1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertUser"</span> <span class="attr">parameterType</span>=<span class="string">"NewsUser"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"userId"</span>&gt;</span></span><br><span class="line">        insert into news_user</span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"("</span> <span class="attr">suffix</span>=<span class="string">")"</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"deptId != null"</span>&gt;</span>dept_id,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span>user_name,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"nickName != null and nickName != ''"</span>&gt;</span>nick_name,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userType != null"</span>&gt;</span>user_type,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"email != null"</span>&gt;</span>email,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"phonenumber != null"</span>&gt;</span>phonenumber,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"sex != null"</span>&gt;</span>sex,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"avatar != null"</span>&gt;</span>avatar,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"password != null"</span>&gt;</span>password,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span>status,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"delFlag != null"</span>&gt;</span>del_flag,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"loginIp != null"</span>&gt;</span>login_ip,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"loginDate != null"</span>&gt;</span>login_date,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"createBy != null"</span>&gt;</span>create_by,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"createTime != null"</span>&gt;</span>create_time,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"updateBy != null"</span>&gt;</span>update_by,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"updateTime != null"</span>&gt;</span>update_time,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"remark != null"</span>&gt;</span>remark,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"values ("</span> <span class="attr">suffix</span>=<span class="string">")"</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"deptId != null"</span>&gt;</span>#{deptId},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span>#{userName},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"nickName != null and nickName != ''"</span>&gt;</span>#{nickName},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userType != null"</span>&gt;</span>#{userType},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"email != null"</span>&gt;</span>#{email},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"phonenumber != null"</span>&gt;</span>#{phonenumber},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"sex != null"</span>&gt;</span>#{sex},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"avatar != null"</span>&gt;</span>#{avatar},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"password != null"</span>&gt;</span>#{password},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span>#{status},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"delFlag != null"</span>&gt;</span>#{delFlag},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"loginIp != null"</span>&gt;</span>#{loginIp},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"loginDate != null"</span>&gt;</span>#{loginDate},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"createBy != null"</span>&gt;</span>#{createBy},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"createTime != null"</span>&gt;</span>#{createTime},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"updateBy != null"</span>&gt;</span>#{updateBy},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"updateTime != null"</span>&gt;</span>#{updateTime},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"remark != null"</span>&gt;</span>#{remark},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"NewsUser"</span>&gt;</span></span><br><span class="line">        update news_user</span><br><span class="line">        <span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"SET"</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"deptId != null"</span>&gt;</span>dept_id = #{deptId},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userName != null and userName != ''"</span>&gt;</span>user_name = #{userName},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"nickName != null and nickName != ''"</span>&gt;</span>nick_name = #{nickName},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userType != null"</span>&gt;</span>user_type = #{userType},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"email != null"</span>&gt;</span>email = #{email},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"phonenumber != null"</span>&gt;</span>phonenumber = #{phonenumber},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"sex != null"</span>&gt;</span>sex = #{sex},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"avatar != null"</span>&gt;</span>avatar = #{avatar},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"password != null"</span>&gt;</span>password = #{password},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span>status = #{status},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"delFlag != null"</span>&gt;</span>del_flag = #{delFlag},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"loginIp != null"</span>&gt;</span>login_ip = #{loginIp},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"loginDate != null"</span>&gt;</span>login_date = #{loginDate},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"createBy != null"</span>&gt;</span>create_by = #{createBy},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"createTime != null"</span>&gt;</span>create_time = #{createTime},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"updateBy != null"</span>&gt;</span>update_by = #{updateBy},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"updateTime != null"</span>&gt;</span>update_time = #{updateTime},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"remark != null"</span>&gt;</span>remark = #{remark},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">        where user_id = #{userId}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteUserByUserId"</span> <span class="attr">parameterType</span>=<span class="string">"Long"</span>&gt;</span></span><br><span class="line">        update news_user set del_flag = '2' where user_id = #{userId}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteUserByUserIds"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span>&gt;</span></span><br><span class="line">        update news_user set del_flag = '2' where user_id in</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"userId"</span> <span class="attr">collection</span>=<span class="string">"array"</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">close</span>=<span class="string">")"</span>&gt;</span></span><br><span class="line">            #{userId}</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserByUserName"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span> <span class="attr">resultMap</span>=<span class="string">"UserResult"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"selectUserVo"</span>/&gt;</span></span><br><span class="line">        where user_name = #{userName} and del_flag = '0' limit 1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUserByPhone"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span> <span class="attr">resultMap</span>=<span class="string">"UserResult"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"selectUserVo"</span>/&gt;</span></span><br><span class="line">        where phonenumber = #{phonenumber} and del_flag = '0' limit 1</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="主-pom-xml-文件增加模块依赖"><a href="#主-pom-xml-文件增加模块依赖" class="headerlink" title="主 pom.xml 文件增加模块依赖"></a>主 pom.xml 文件增加模块依赖</h2><h4 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h4><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">    ...</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line"><span class="addition">+            &lt;dependency&gt;</span></span><br><span class="line"><span class="addition">+                &lt;groupId&gt;com.codezm&lt;/groupId&gt;</span></span><br><span class="line"><span class="addition">+                &lt;artifactId&gt;auths&lt;/artifactId&gt;</span></span><br><span class="line"><span class="addition">+                &lt;version&gt;${ruoyi.version}&lt;/version&gt;</span></span><br><span class="line"><span class="addition">+            &lt;/dependency&gt;</span></span><br><span class="line">         &lt;/dependencies&gt;</span><br><span class="line">     &lt;/dependencyManagement&gt;</span><br><span class="line">     &lt;modules&gt;</span><br><span class="line">      ...</span><br><span class="line">         &lt;module&gt;ruoyi-quartz&lt;/module&gt;</span><br><span class="line">         &lt;module&gt;ruoyi-generator&lt;/module&gt;</span><br><span class="line">         &lt;module&gt;ruoyi-common&lt;/module&gt;</span><br><span class="line"><span class="addition">+        &lt;module&gt;auths&lt;/module&gt;</span></span><br><span class="line">     &lt;/modules&gt;</span><br></pre></td></tr></tbody></table></figure><h2 id="ruoyi-framework"><a href="#ruoyi-framework" class="headerlink" title="ruoyi-framework"></a>ruoyi-framework</h2><h4 id="增加依赖配置"><a href="#增加依赖配置" class="headerlink" title="增加依赖配置"></a>增加依赖配置</h4><p>ruoyi-framework/pom.xml</p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">    ...</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line"><span class="addition">+        &lt;dependency&gt;</span></span><br><span class="line"><span class="addition">+            &lt;groupId&gt;com.codezm&lt;/groupId&gt;</span></span><br><span class="line"><span class="addition">+            &lt;artifactId&gt;auths&lt;/artifactId&gt;</span></span><br><span class="line"><span class="addition">+        &lt;/dependency&gt;</span></span><br><span class="line">     &lt;/dependencies&gt;</span><br><span class="line">&lt;/dependencyManagement&gt;</span><br></pre></td></tr></tbody></table></figure><h4 id="ruoyi-framework-中创建基础-spring-security-配置文件"><a href="#ruoyi-framework-中创建基础-spring-security-配置文件" class="headerlink" title="ruoyi-framework 中创建基础 spring security 配置文件"></a>ruoyi-framework 中创建基础 spring security 配置文件</h4><p>ruoyi-framework/src/main/java/com/ruoyi/framework/config/SecurityBaseConfig.java</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ruoyi.framework.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.config.NewsSecurityConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * spring security配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span></span><br><span class="line"><span class="meta">@Import({SecurityConfig.class, NewsSecurityConfig.class})</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityBaseConfig</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ruoyi-framework/src/main/java/com/ruoyi/framework/config/SecurityConfig.java</p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"> import org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"> import org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="addition">+import org.springframework.context.annotation.Configuration;</span></span><br><span class="line"><span class="addition">+import org.springframework.context.annotation.Primary;</span></span><br><span class="line"><span class="addition">+import org.springframework.core.annotation.Order;</span></span><br><span class="line"> import org.springframework.http.HttpMethod;</span><br><span class="line"> import org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"> import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line">@@ -27,7 +30,9 @@ import org.springframework.web.filter.CorsFilter;</span><br><span class="line">  *</span><br><span class="line">  * @author ruoyi</span><br><span class="line">  */</span><br><span class="line"><span class="deletion">-@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span></span><br><span class="line"><span class="addition">+//@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span></span><br><span class="line"><span class="addition">+@Configuration</span></span><br><span class="line"><span class="addition">+@Order(999)</span></span><br><span class="line"> public class SecurityConfig extends WebSecurityConfigurerAdapter</span><br><span class="line"> {</span><br><span class="line">     /**</span><br><span class="line">@@ -82,7 +87,8 @@ public class SecurityConfig extends WebSecurityConfigurerAdapter</span><br><span class="line">      * @return</span><br><span class="line">      * @throws Exception</span><br><span class="line">      */</span><br><span class="line"><span class="deletion">-    @Bean</span></span><br><span class="line"><span class="addition">+    @Bean("manageAuthenticationManager")</span></span><br><span class="line"><span class="addition">+    @Primary</span></span><br><span class="line">     @Override</span><br><span class="line">     public AuthenticationManager authenticationManagerBean() throws Exception</span><br><span class="line">     {</span><br></pre></td></tr></tbody></table></figure><h2 id="增加-token-环境变量"><a href="#增加-token-环境变量" class="headerlink" title="增加 token 环境变量"></a>增加 token 环境变量</h2><p>ruoyi-admin/src/main/resources/application.yml</p><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+# token配置</span></span><br><span class="line"><span class="addition">+news:</span></span><br><span class="line"><span class="addition">+  token:</span></span><br><span class="line"><span class="addition">+    # 令牌自定义标识-统一或者和前端商定</span></span><br><span class="line"><span class="addition">+    header: Authorization</span></span><br><span class="line"><span class="addition">+    # 令牌密钥</span></span><br><span class="line"><span class="addition">+    secret: abcdefgcodepiaonopqrstuvwxyz</span></span><br><span class="line"><span class="addition">+    # 令牌有效期（默认30分钟）</span></span><br><span class="line"><span class="addition">+    expireTime: 120</span></span><br><span class="line"><span class="addition">+</span></span><br></pre></td></tr></tbody></table></figure><h2 id="登录-Controller"><a href="#登录-Controller" class="headerlink" title="登录 Controller"></a>登录 Controller</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.codezm.news.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.domain.newsLoginBody;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.service.LoginService;</span><br><span class="line"><span class="keyword">import</span> com.codezm.auths.news.untils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.constant.Constants;</span><br><span class="line"><span class="keyword">import</span> com.ruoyi.common.core.domain.AjaxResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> codezm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024-05-14 15:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping("/news")</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginService loginService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping("/login")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AjaxResult <span class="title">login</span><span class="params">(<span class="meta">@RequestBody</span> newsLoginBody newsLoginBody)</span> </span>{</span><br><span class="line">        AjaxResult ajax = AjaxResult.success();</span><br><span class="line"><span class="comment">//         生成令牌</span></span><br><span class="line">        String token = loginService.login(newsLoginBody.getUsername(), newsLoginBody.getPassword(), newsLoginBody.getCode(), newsLoginBody.getUuid());</span><br><span class="line">        ajax.put(Constants.TOKEN, token);</span><br><span class="line">        <span class="keyword">return</span> ajax;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/info")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">info</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> SecurityUtils.getUsername();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="表SQL"><a href="#表SQL" class="headerlink" title="表SQL"></a>表SQL</h2><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`news_user`</span> (</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'用户ID'</span>,</span><br><span class="line">  <span class="string">`dept_id`</span> <span class="built_in">bigint</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'部门ID'</span>,</span><br><span class="line">  <span class="string">`user_name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户账号'</span>,</span><br><span class="line">  <span class="string">`nick_name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户昵称'</span>,</span><br><span class="line">  <span class="string">`user_type`</span> <span class="built_in">varchar</span>(<span class="number">2</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">'00'</span> <span class="keyword">COMMENT</span> <span class="string">'用户类型（00系统用户）'</span>,</span><br><span class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'用户邮箱'</span>,</span><br><span class="line">  <span class="string">`phonenumber`</span> <span class="built_in">varchar</span>(<span class="number">11</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'手机号码'</span>,</span><br><span class="line">  <span class="string">`sex`</span> <span class="built_in">char</span>(<span class="number">1</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'用户性别（0男 1女 2未知）'</span>,</span><br><span class="line">  <span class="string">`avatar`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'头像地址'</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'密码'</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">char</span>(<span class="number">1</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'帐号状态（0正常 1停用）'</span>,</span><br><span class="line">  <span class="string">`del_flag`</span> <span class="built_in">char</span>(<span class="number">1</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'删除标志（0代表存在 2代表删除）'</span>,</span><br><span class="line">  <span class="string">`login_ip`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'最后登录IP'</span>,</span><br><span class="line">  <span class="string">`login_date`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'最后登录时间'</span>,</span><br><span class="line">  <span class="string">`create_by`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'创建者'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_by`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'更新者'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">  <span class="string">`remark`</span> <span class="built_in">varchar</span>(<span class="number">500</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'备注'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`user_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">100</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_general_ci <span class="keyword">COMMENT</span>=<span class="string">'用户信息表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`ruoyi`</span>.<span class="string">`sys_user`</span>(<span class="string">`user_id`</span>, <span class="string">`dept_id`</span>, <span class="string">`user_name`</span>, <span class="string">`nick_name`</span>, <span class="string">`user_type`</span>, <span class="string">`email`</span>, <span class="string">`phonenumber`</span>, <span class="string">`sex`</span>, <span class="string">`avatar`</span>, <span class="string">`password`</span>, <span class="string">`status`</span>, <span class="string">`del_flag`</span>, <span class="string">`login_ip`</span>, <span class="string">`login_date`</span>, <span class="string">`create_by`</span>, <span class="string">`create_time`</span>, <span class="string">`update_by`</span>, <span class="string">`update_time`</span>, <span class="string">`remark`</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">103</span>, <span class="string">'admin'</span>, <span class="string">'若依'</span>, <span class="string">'00'</span>, <span class="string">'ry@163.com'</span>, <span class="string">'15888888888'</span>, <span class="string">'1'</span>, <span class="string">''</span>, <span class="string">'$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2'</span>, <span class="string">'0'</span>, <span class="string">'0'</span>, <span class="string">'127.0.0.1'</span>, <span class="string">'2022-12-28 15:47:23'</span>, <span class="string">'admin'</span>, <span class="string">'2022-12-11 16:51:52'</span>, <span class="string">''</span>, <span class="string">'2022-12-28 15:47:22'</span>, <span class="string">'管理员'</span>);</span><br></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;若依用户分表鉴权&quot;&gt;&lt;a href=&quot;#若依用户分表鉴权&quot; class=&quot;headerlink&quot; title=&quot;若依用户分表鉴权&quot;&gt;&lt;/a&gt;若依用户分表鉴权&lt;/h1&gt;&lt;p&gt;若依自带了管理后台及服务端，但项目通常还有客户端业务。那客户端如何实现鉴权？最简单的方式是在原有的 sys_user 上增加业务逻辑，但随着项目越做越大耦合度也会成倍增加。那解耦就势在必行。&lt;/p&gt;
&lt;p&gt;本篇将介绍如何让客户端拥有一套独立表来实现用户鉴权。完整代码&lt;a href=&quot;https://github.com/codezm/codezm-auths&quot;&gt;参见&lt;/a&gt;。&lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="https://codezm.github.io/categories/java/"/>
    
    
    <category term="java" scheme="https://codezm.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Docker-制作whistle镜像</title>
    <link href="https://codezm.github.io/posts/Docker/53910851.html"/>
    <id>https://codezm.github.io/posts/Docker/53910851.html</id>
    <published>2024-05-11T10:59:09.000Z</published>
    <updated>2025-12-01T08:02:38.163Z</updated>
    
    <content type="html"><![CDATA[<p>本篇将介绍如何通过 Github 的 Action 自动化脚本制作 whistle 的 docker 镜像并发布到 ghcr.io 上。</p><p><a href="https://github.com/codezm/whistle">https://github.com/codezm/whistle</a></p><a id="more"></a><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:lts-alpine3.<span class="number">18</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install -g whistle</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"w2 run"</span>]</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h3><p>任何 Git 的 push 动作将触发脚本的执行。本脚本将构建 linux/amd64 平台的 docker 镜像，交叉编译多平台可参见：<a href="https://github.com/codezm/whistle/blob/master/.github/workflows/docker.yml">https://github.com/codezm/whistle/blob/master/.github/workflows/docker.yml</a></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Docker</span> <span class="string">Image</span> <span class="string">CI</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="string">push</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">GHCR_IMAGE_NAME:</span> <span class="string">${{</span> <span class="string">github.repository</span> <span class="string">}}</span></span><br><span class="line">  <span class="attr">GHCR_TOKEN:</span> <span class="string">${{</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">}}</span></span><br><span class="line">  <span class="attr">GHCR_USERNAME:</span> <span class="string">${{</span> <span class="string">github.actor</span> <span class="string">}}</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">docker_build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">permissions:</span></span><br><span class="line">      <span class="attr">contents:</span> <span class="string">read</span></span><br><span class="line">      <span class="attr">packages:</span> <span class="string">write</span></span><br><span class="line">      <span class="attr">attestations:</span> <span class="string">write</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Login</span> <span class="string">to</span> <span class="string">GHCR</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/login-action@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">registry:</span> <span class="string">ghcr.io</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">${{</span> <span class="string">env.GHCR_USERNAME</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">${{</span> <span class="string">env.GHCR_TOKEN</span> <span class="string">}}</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Docker</span> <span class="string">meta</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">meta</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/metadata-action@v5</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">images:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">ghcr.io/${{</span> <span class="string">env.GHCR_IMAGE_NAME</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">tags:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">type=ref,event=tag</span></span><br><span class="line">            <span class="string">type=raw,value=latest,enable=${{</span> <span class="string">startsWith(github.ref,</span> <span class="string">'refs/tags/'</span><span class="string">)</span> <span class="string">}}</span></span><br><span class="line">            <span class="string">type=pep440,pattern={{raw}},enable=${{</span> <span class="string">startsWith(github.ref,</span> <span class="string">'refs/tags/'</span><span class="string">)</span> <span class="string">}}</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/build-push-action@v5</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">          <span class="attr">push:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">tags:</span> <span class="string">${{</span> <span class="string">steps.meta.outputs.tags</span> <span class="string">}}</span></span><br><span class="line">          <span class="attr">labels:</span> <span class="string">${{</span> <span class="string">steps.meta.outputs.labels</span> <span class="string">}}</span></span><br></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;本篇将介绍如何通过 Github 的 Action 自动化脚本制作 whistle 的 docker 镜像并发布到 ghcr.io 上。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/codezm/whistle&quot;&gt;https://github.com/codezm/whistle&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Docker" scheme="https://codezm.github.io/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://codezm.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker 镜像仓库</title>
    <link href="https://codezm.github.io/posts/Docker/d6d418a.html"/>
    <id>https://codezm.github.io/posts/Docker/d6d418a.html</id>
    <published>2024-05-11T10:21:53.000Z</published>
    <updated>2025-12-01T08:02:38.163Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker-镜像仓库"><a href="#Docker-镜像仓库" class="headerlink" title="Docker 镜像仓库"></a>Docker 镜像仓库</h1><ul><li><a href="https://hub.docker.com/">hub.docker.com</a></li><li><a href="https://ghcr.io/">ghcr.io</a></li></ul><h2 id="ghcr-io简介"><a href="#ghcr-io简介" class="headerlink" title="ghcr.io简介"></a>ghcr.io简介</h2><p>ghcr.io 是GitHub Container Registry 的域名。 </p><p>GitHub Container Registry 是GitHub 提供的容器镜像注册表服务，允许开发者在GitHub 上存储、管理和分享Docker 镜像。</p><h2 id="阿里云容器镜像服务"><a href="#阿里云容器镜像服务" class="headerlink" title="阿里云容器镜像服务"></a>阿里云容器镜像服务</h2><p><a href="https://cr.console.aliyun.com/cn-hangzhou/instances">https://cr.console.aliyun.com/cn-hangzhou/instances</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Docker-镜像仓库&quot;&gt;&lt;a href=&quot;#Docker-镜像仓库&quot; class=&quot;headerlink&quot; title=&quot;Docker 镜像仓库&quot;&gt;&lt;/a&gt;Docker 镜像仓库&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://hub.docker.</summary>
      
    
    
    
    <category term="Docker" scheme="https://codezm.github.io/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://codezm.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Chrome中如何禁用JavaScript来实现复制自由</title>
    <link href="https://codezm.github.io/posts/Chrome/e3041ae7.html"/>
    <id>https://codezm.github.io/posts/Chrome/e3041ae7.html</id>
    <published>2024-01-05T17:27:27.000Z</published>
    <updated>2025-12-01T08:02:38.160Z</updated>
    
    <content type="html"><![CDATA[<p>Chrome中如何禁用JavaScript来实现复制自由</p><a id="more"></a><h1 id="禁用或启用-JavaScript"><a href="#禁用或启用-JavaScript" class="headerlink" title="禁用或启用 JavaScript"></a>禁用或启用 JavaScript</h1><ol><li>Chrome 打开 DevTools（F12 / ⌥+⌘+J）</li><li>⌘ + ⇪ + P（Ctrl + shift + P） 打开 Command Menu</li><li>输入<code>Disable JavaScript</code> 来启用或禁用。需要还原时再输入：<code>Enable JavaScript</code>。</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;Chrome中如何禁用JavaScript来实现复制自由&lt;/p&gt;</summary>
    
    
    
    <category term="Chrome" scheme="https://codezm.github.io/categories/Chrome/"/>
    
    
    <category term="Chrome" scheme="https://codezm.github.io/tags/Chrome/"/>
    
    <category term="JavaScript" scheme="https://codezm.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>Chrome快捷键</title>
    <link href="https://codezm.github.io/posts/Chrome/kjj.html"/>
    <id>https://codezm.github.io/posts/Chrome/kjj.html</id>
    <published>2023-12-21T16:15:07.000Z</published>
    <updated>2025-12-01T08:02:38.160Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Chrome快捷键"><a href="#Chrome快捷键" class="headerlink" title="Chrome快捷键"></a>Chrome快捷键</h2><table><thead><tr><th>快捷键</th><th>功能</th></tr></thead><tbody><tr><td>⇪⌘B</td><td>显示/隐藏书签栏</td></tr><tr><td>⌘,</td><td>打开设置页</td></tr><tr><td>⌥⌘L</td><td>下载内容</td></tr><tr><td>⌘Y</td><td>历史记录</td></tr><tr><td>⇪B</td><td>打开书签检索框</td></tr><tr><td>⌃⇥</td><td>切换至下一个标签页</td></tr><tr><td>⌃⇪⇥</td><td>切换至上一个标签页</td></tr></tbody></table><h2 id="Chrome-浏览器下载"><a href="#Chrome-浏览器下载" class="headerlink" title="Chrome 浏览器下载"></a>Chrome 浏览器下载</h2><p><strong>默认当前系统版本：</strong><br><a href="https://www.google.cn/intl/zh-CN/chrome/">https://www.google.cn/intl/zh-CN/chrome/</a></p><p><strong>Windows 64：</strong><br><a href="https://www.google.cn/intl/zh-CN/chrome/?standalone=1&amp;platform=win64">https://www.google.cn/intl/zh-CN/chrome/?standalone=1&amp;platform=win64</a></p><p><strong>Windows 32：</strong><br><a href="https://www.google.cn/intl/zh-CN/chrome/?standalone=1&amp;platform=win">https://www.google.cn/intl/zh-CN/chrome/?standalone=1&amp;platform=win</a></p><p><strong>Mac：</strong><br><a href="https://www.google.cn/intl/zh-CN/chrome/?standalone=1&amp;platform=mac">https://www.google.cn/intl/zh-CN/chrome/?standalone=1&amp;platform=mac</a></p><p><strong>Linux：</strong><br><a href="https://www.google.cn/intl/zh-CN/chrome/?standalone=1&amp;platform=linux">https://www.google.cn/intl/zh-CN/chrome/?standalone=1&amp;platform=linux</a></p><p><strong>历史版本：</strong><br><a href="https://www.slimjet.com/chrome/google-chrome-old-version.php">https://www.slimjet.com/chrome/google-chrome-old-version.php</a></p><p>url 的参数说明：</p><p><code>standalone=1</code>：下载最新的完整离线安装包</p><p><code>platform=win64</code>：适用于Windows操作系统，64代表64位</p><p><code>platform=win</code>：如果不写64，就是下载的32位安装包</p><p><code>installdataindex=defaultbrowser</code>： 设置 Chrome 为默认浏览器，</p><p><code>installdataindex=empty</code>：不设置 Chrome 为默认浏览器</p><p><code>extra=stablechannel</code>：指定下载的版本为稳定版，还有其他版本（betachannel、devchannel、canarychannel）分别是测试版、开发版、金丝雀版</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Chrome快捷键&quot;&gt;&lt;a href=&quot;#Chrome快捷键&quot; class=&quot;headerlink&quot; title=&quot;Chrome快捷键&quot;&gt;&lt;/a&gt;Chrome快捷键&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;快捷键&lt;/th&gt;
&lt;th&gt;功能&lt;/th&gt;</summary>
      
    
    
    
    <category term="Chrome" scheme="https://codezm.github.io/categories/Chrome/"/>
    
    
    <category term="Chrome" scheme="https://codezm.github.io/tags/Chrome/"/>
    
  </entry>
  
  <entry>
    <title>MySQL数据库引擎InnoDB物理文件备份</title>
    <link href="https://codezm.github.io/posts/MySQL/7b6f5b70.html"/>
    <id>https://codezm.github.io/posts/MySQL/7b6f5b70.html</id>
    <published>2023-12-13T12:05:00.000Z</published>
    <updated>2025-12-01T08:02:38.185Z</updated>
    
    <content type="html"><![CDATA[<h1 id="MySQL数据库引擎InnoDB物理文件备份"><a href="#MySQL数据库引擎InnoDB物理文件备份" class="headerlink" title="MySQL数据库引擎InnoDB物理文件备份"></a>MySQL数据库引擎InnoDB物理文件备份</h1><p>Percona XtraBackup（简称PXB）是 <a href="https://www.percona.com/software/mysql-database/percona-xtrabackup">Percona</a> 公司开发的一个用于 MySQL 数据库物理热备的备份工具，支持 MySQL（Oracle）、Percona Server 和 MariaDB。</p><a id="more"></a><h2 id="XtraBackup"><a href="#XtraBackup" class="headerlink" title="XtraBackup"></a>XtraBackup</h2><ul><li>Github：<a href="https://github.com/percona/percona-xtrabackup">https://github.com/percona/percona-xtrabackup</a></li><li><code>apt</code> and <code>yum</code> package repositories ：<a href="https://repo.percona.com/percona/yum/release/centos/7/RPMS/x86_64/">https://repo.percona.com/percona/yum/release/centos/7/RPMS/x86_64/</a></li></ul><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><h3 id="1-生成SQL"><a href="#1-生成SQL" class="headerlink" title="1. 生成SQL"></a>1. 生成SQL</h3><ul><li>生成丢弃表空间的SQL</li><li>生成导入表空间的SQL</li><li>导出表结构SQL&amp;移除表结构SQL中的表外键</li><li>更改数据库名</li></ul><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- mysql 使用 --secure-file-priv 参数启用，需查看允许导出的目录。</span></span><br><span class="line"><span class="comment">-- SHOW VARIABLES LIKE "secure_file_priv";</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成丢弃表空间的SQL</span></span><br><span class="line">mysql&gt; select concat('alter table ',table_schema,'.',TABLE_NAME , ' discard tablespace', ';') from  information_schema.tables where TABLE_SCHEMA = 'school_last1' into outfile '/var/lib/mysql-files/discard.sql';</span><br><span class="line">Query OK, 75 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成导入表空间的SQL</span></span><br><span class="line">mysql&gt; select concat('alter table ',table_schema,'.',TABLE_NAME , ' import tablespace', ';') from  information_schema.tables where TABLE_SCHEMA = 'school_last1' into outfile '/var/lib/mysql-files/import.sql';</span><br><span class="line">Query OK, 75 rows affected (0.00 sec)</span><br></pre></td></tr></tbody></table></figure><p>导出 <code>school_last1</code> 数据库中所有表的结构</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysqldump -uroot -proot -d school_last1 &gt; school_last1-table-structure.sql</span><br></pre></td></tr></tbody></table></figure><p>删除表外键（在后期删除表空间时有影响）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看表外键</span></span><br><span class="line"><span class="comment"># grep "CONSTRAINT.*RESTRICT" school_last1-table-structure.sql</span></span><br><span class="line">$ sed -i -e <span class="string">":a;N;s/,\n/,,/g;$!ba;"</span> school_last1-table-structure.sql</span><br><span class="line">$ sed -i -e <span class="string">"s/,,\s*CONSTRAINT.*RESTRICT//g;s/,,/,\n/g"</span> school_last1-table-structure.sql</span><br></pre></td></tr></tbody></table></figure><p>修改数据库名</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i -e <span class="string">"s/school_last1/school/g"</span> discard.sql</span><br><span class="line">$ sed -i -e <span class="string">"s/school_last1/school/g"</span> import.sql</span><br></pre></td></tr></tbody></table></figure><h3 id="2-备份指定数据库"><a href="#2-备份指定数据库" class="headerlink" title="2. 备份指定数据库"></a>2. 备份指定数据库</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># on 10.10.16.10</span></span><br><span class="line">$ curl https://repo.percona.com/percona/yum/release/centos/7/RPMS/x86_64/percona-xtrabackup-80-8.0.27-19.1.el7.x86_64.rpm</span><br><span class="line">$ yum install -y percona-xtrabackup-80-8.0.27-19.1.el7.x86_64.rpm</span><br><span class="line">$ xtrabackup --backup --target-dir=/tmp/mysql \</span><br><span class="line">--datadir=/home/htdocs/mysql</span><br><span class="line">--user=root \</span><br><span class="line">--password=root \</span><br><span class="line">--host=127.0.0.1 \</span><br><span class="line">--port=3307 \</span><br><span class="line">--databases=school_last1 \</span><br><span class="line">--use-memory=4G</span><br><span class="line"></span><br><span class="line">xtrabackup: recognized server arguments: --datadir=/var/lib/mysql --datadir=/home/htdocs/mysql</span><br><span class="line">xtrabackup: recognized client arguments: --backup=1 --target-dir=/tmp/mysql --user=root --password=* --host=127.0.0.1 --port=3307 --databases=school_last1 --use-memory=4G</span><br><span class="line">xtrabackup version 8.0.27-19 based on MySQL server 8.0.27 Linux (x86_64) (revision id: 50dbc8dadda)</span><br><span class="line">230912 17:32:31  version_check Connecting to MySQL server with DSN <span class="string">'dbi:mysql:;mysql_read_default_group=xtrabackup;host=127.0.0.1;port=3307'</span> as <span class="string">'root'</span>  (using password: YES).</span><br><span class="line">...</span><br><span class="line">xtrabackup: Transaction <span class="built_in">log</span> of lsn (79075768667) to (79076184216) was copied.</span><br><span class="line">230912 17:37:57 completed OK!</span><br><span class="line">$ xtrabackup --apply-log-only --prepare --<span class="built_in">export</span> --target-dir=/tmp/mysql</span><br></pre></td></tr></tbody></table></figure><p>xtrabackup 工具参数：</p><ul><li><p>–backup 将备份保存到 target-dir</p></li><li><p>—target-dir 指定备份目录路径</p></li><li><p>–datadir 数据库物理路径</p></li><li><p>–use-memory 导出时可使用的内存限制，默认：100MB</p></li><li><p>–databases 指定要备份数据库名</p></li></ul><blockquote><p>mysqldump 导出的sql文件近 6GB，xtrabackup 备份用时不到 6 分钟。</p></blockquote><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># on 10.10.16.10</span></span><br><span class="line">$ mv school_last1-table-structure.sql import.sql discard.sql /tmp/mysql/</span><br><span class="line">$ tar czvf school_last1.tar.gz /tmp/mysql</span><br><span class="line">$ ls -lah</span><br><span class="line">-rw-r--r--.  1 root root  3.4G 9月  13 09:52 school_last1.tar.gz</span><br><span class="line">$ du -d 1 -h</span><br><span class="line">25G./mysql</span><br><span class="line">$ scp /tmp/school_last1.tar.gz c79user@10.10.51.81:/tmp/</span><br></pre></td></tr></tbody></table></figure><h3 id="3-还原数据库表结构"><a href="#3-还原数据库表结构" class="headerlink" title="3. 还原数据库表结构"></a>3. 还原数据库表结构</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># on 10.10.51.81</span></span><br><span class="line">$ mkdir /data1/mysql-bk &amp;&amp; tar zxvf /tmp/school_last1.tar.gz -C /data1/mysql-bk</span><br></pre></td></tr></tbody></table></figure><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># on 10.10.51.81</span></span><br><span class="line">mysql&gt; create database school default character set utf8mb4 collate utf8mb4_general_ci;</span><br><span class="line">mysql&gt; use school;</span><br><span class="line">mysql&gt; source /data1/mysql-bk/tmp/mysql/school_last1-table-structure.sql;</span><br><span class="line"><span class="comment"># 删除表空间</span></span><br><span class="line">mysql&gt; source /data1/mysql-bk/tmp/mysql/discard.sql;</span><br></pre></td></tr></tbody></table></figure><h3 id="4-迁移数据库表物理文件"><a href="#4-迁移数据库表物理文件" class="headerlink" title="4. 迁移数据库表物理文件"></a>4. 迁移数据库表物理文件</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># on 10.10.51.81</span></span><br><span class="line">$ mv /data1/mysql-bk/tmp/mysql/school_last1/* /data1/mysql/data/school/</span><br><span class="line">$ chown -R mysql:mysql /data1/mysql/data/school</span><br></pre></td></tr></tbody></table></figure><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># on 10.10.51.81</span></span><br><span class="line"><span class="comment"># 导入表空间</span></span><br><span class="line">mysql&gt; source /data1/mysql-bk/tmp/mysql/import.sql;</span><br></pre></td></tr></tbody></table></figure><h3 id="5-还原表外键"><a href="#5-还原表外键" class="headerlink" title="5. 还原表外键"></a>5. 还原表外键</h3><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># on 10.10.51.81</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> qrtz_blob_triggers <span class="keyword">add</span> <span class="keyword">CONSTRAINT</span> <span class="string">`qrtz_blob_triggers_ibfk_1`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`sched_name`</span>, <span class="string">`trigger_name`</span>, <span class="string">`trigger_group`</span>) <span class="keyword">REFERENCES</span> <span class="string">`qrtz_triggers`</span> (<span class="string">`sched_name`</span>, <span class="string">`trigger_name`</span>, <span class="string">`trigger_group`</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> qrtz_cron_triggers <span class="keyword">add</span> <span class="keyword">CONSTRAINT</span> <span class="string">`qrtz_cron_triggers_ibfk_1`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`sched_name`</span>, <span class="string">`trigger_name`</span>, <span class="string">`trigger_group`</span>) <span class="keyword">REFERENCES</span> <span class="string">`qrtz_triggers`</span> (<span class="string">`sched_name`</span>, <span class="string">`trigger_name`</span>, <span class="string">`trigger_group`</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> qrtz_simprop_triggers <span class="keyword">add</span> <span class="keyword">CONSTRAINT</span> <span class="string">`qrtz_simprop_triggers_ibfk_1`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`sched_name`</span>, <span class="string">`trigger_name`</span>, <span class="string">`trigger_group`</span>) <span class="keyword">REFERENCES</span> <span class="string">`qrtz_triggers`</span> (<span class="string">`sched_name`</span>, <span class="string">`trigger_name`</span>, <span class="string">`trigger_group`</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> qrtz_simple_triggers <span class="keyword">add</span> <span class="keyword">CONSTRAINT</span> <span class="string">`qrtz_simple_triggers_ibfk_1`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`sched_name`</span>, <span class="string">`trigger_name`</span>, <span class="string">`trigger_group`</span>) <span class="keyword">REFERENCES</span> <span class="string">`qrtz_triggers`</span> (<span class="string">`sched_name`</span>, <span class="string">`trigger_name`</span>, <span class="string">`trigger_group`</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> qrtz_triggers <span class="keyword">add</span> <span class="keyword">CONSTRAINT</span> <span class="string">`qrtz_triggers_ibfk_1`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`sched_name`</span>, <span class="string">`job_name`</span>, <span class="string">`job_group`</span>) <span class="keyword">REFERENCES</span> <span class="string">`qrtz_job_details`</span> (<span class="string">`sched_name`</span>, <span class="string">`job_name`</span>, <span class="string">`job_group`</span>) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT;</span><br></pre></td></tr></tbody></table></figure><h3 id="6-清理"><a href="#6-清理" class="headerlink" title="6. 清理"></a>6. 清理</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># on 10.10.51.81</span></span><br><span class="line">rm -rf /tmp/school_last1.tar.gz</span><br><span class="line">rm -rf /data1/mysql-bk</span><br><span class="line"></span><br><span class="line"><span class="comment"># on 10.10.16.10</span></span><br><span class="line">rm -rf /tmp/school_last1.tar.gz /tmp/mysql</span><br></pre></td></tr></tbody></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过上述方式备份及还原数据库时，支持热备及热还原。中途并未暂停及重启过位于 <code>10.10.16.10</code> 及 <code>10.10.51.81</code> 上的数据库。</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;MySQL数据库引擎InnoDB物理文件备份&quot;&gt;&lt;a href=&quot;#MySQL数据库引擎InnoDB物理文件备份&quot; class=&quot;headerlink&quot; title=&quot;MySQL数据库引擎InnoDB物理文件备份&quot;&gt;&lt;/a&gt;MySQL数据库引擎InnoDB物理文件备份&lt;/h1&gt;&lt;p&gt;Percona XtraBackup（简称PXB）是 &lt;a href=&quot;https://www.percona.com/software/mysql-database/percona-xtrabackup&quot;&gt;Percona&lt;/a&gt; 公司开发的一个用于 MySQL 数据库物理热备的备份工具，支持 MySQL（Oracle）、Percona Server 和 MariaDB。&lt;/p&gt;</summary>
    
    
    
    <category term="MySQL" scheme="https://codezm.github.io/categories/MySQL/"/>
    
    
    <category term="MySQL" scheme="https://codezm.github.io/tags/MySQL/"/>
    
    <category term="InnoDB" scheme="https://codezm.github.io/tags/InnoDB/"/>
    
    <category term="XtraBackup" scheme="https://codezm.github.io/tags/XtraBackup/"/>
    
  </entry>
  
  <entry>
    <title>Windows系统常用快捷键</title>
    <link href="https://codezm.github.io/posts/Windows/kjj.html"/>
    <id>https://codezm.github.io/posts/Windows/kjj.html</id>
    <published>2023-12-01T14:08:41.000Z</published>
    <updated>2025-12-01T08:02:38.209Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Windows系统常用快捷键"><a href="#Windows系统常用快捷键" class="headerlink" title="Windows系统常用快捷键"></a>Windows系统常用快捷键</h1><table><thead><tr><th>快捷键</th><th>功能</th></tr></thead><tbody><tr><td>win</td><td>打开开始屏幕</td></tr><tr><td>win+r</td><td>打开运行窗口</td></tr><tr><td>win+d</td><td>快速回桌面</td></tr><tr><td>win+i</td><td>设置</td></tr><tr><td>win+e</td><td>资源管理器，类似我的电脑</td></tr><tr><td>win+l</td><td>快速锁屏</td></tr><tr><td>win+s</td><td>快速小娜搜索，比浏览器查百度好多了</td></tr><tr><td>win+p</td><td>映射</td></tr><tr><td>win+tab</td><td>多工作区域切换</td></tr><tr><td>win+pause</td><td>电脑信息</td></tr><tr><td>win+x</td><td>快捷菜单</td></tr><tr><td>win+prtsc</td><td>全屏截图 截图在资源管理器图片</td></tr><tr><td>win+shift+s</td><td>win10最骚截图功能</td></tr><tr><td>ctrl+p</td><td>快速打印，甚至网页内容都可以打印</td></tr><tr><td>ctrl+alt+delete</td><td>任务管理器，系统软中断</td></tr><tr><td>shift+delete</td><td>彻底删除</td></tr><tr><td>alt+tab</td><td>任务切换</td></tr><tr><td>f1</td><td>windows应用程序帮助页面</td></tr><tr><td>f2</td><td>快速重命名</td></tr><tr><td>f3</td><td>资源管理器内快速搜索文件</td></tr><tr><td>f4</td><td>资源管理器中显示地址列表</td></tr><tr><td></td><td></td></tr><tr><td>以下功能全部基于win+r</td><td></td></tr><tr><td></td><td></td></tr><tr><td>cmd</td><td>命令提示符</td></tr><tr><td>winver</td><td>windows版本信息</td></tr><tr><td>calc</td><td>计算器</td></tr><tr><td>dxdiag</td><td>dx检测工具</td></tr><tr><td>mspaint</td><td>画图</td></tr><tr><td>msconfig</td><td>修改启动引导</td></tr><tr><td>regedit</td><td>注册表编辑器</td></tr><tr><td>gpedit.msc</td><td>策略组编辑器</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Windows系统常用快捷键&quot;&gt;&lt;a href=&quot;#Windows系统常用快捷键&quot; class=&quot;headerlink&quot; title=&quot;Windows系统常用快捷键&quot;&gt;&lt;/a&gt;Windows系统常用快捷键&lt;/h1&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;</summary>
      
    
    
    
    <category term="Windows" scheme="https://codezm.github.io/categories/Windows/"/>
    
    
    <category term="Windows" scheme="https://codezm.github.io/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>Vue中实现el-table导出xlsx文件下载</title>
    <link href="https://codezm.github.io/posts/Vue/386f97a7.html"/>
    <id>https://codezm.github.io/posts/Vue/386f97a7.html</id>
    <published>2023-10-17T11:23:01.000Z</published>
    <updated>2025-12-01T08:02:38.316Z</updated>
    
    <content type="html"><![CDATA[<p>Vue中实现el-table导出xlsx文件下载</p><a id="more"></a><h2 id="安装-xlsx-组件"><a href="#安装-xlsx-组件" class="headerlink" title="安装 xlsx 组件"></a>安装 xlsx 组件</h2><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm install --save xlsx</span><br></pre></td></tr></tbody></table></figure><h2 id="实现代码示例"><a href="#实现代码示例" class="headerlink" title="实现代码示例"></a>实现代码示例</h2><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-table id="download" ...&gt;</span><br><span class="line">  &lt;/el-table&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  import * as XLSX from 'xlsx';</span><br><span class="line">import FileSaver from 'file-saver';</span><br><span class="line">  export default {</span><br><span class="line">    methods: {</span><br><span class="line">      /** 导出按钮操作 */</span><br><span class="line">      handleExport() {</span><br><span class="line">        let xlsxParam = {raw:true}</span><br><span class="line">        var wb = XLSX.utils.table_to_book(</span><br><span class="line">          document.querySelector("#download"),</span><br><span class="line">          xlsxParam</span><br><span class="line">        );</span><br><span class="line">        var wbout = XLSX.write(wb, {</span><br><span class="line">            bookType: "xlsx",</span><br><span class="line">            bookSST: true,</span><br><span class="line">            type: "array"</span><br><span class="line">        });</span><br><span class="line">        try {</span><br><span class="line">            FileSaver.saveAs(</span><br><span class="line">                new Blob([wbout], { type: "application/octet-stream" }),</span><br><span class="line">                `调查问卷-${this.parseTime(new Date(), '{y}_{m}_{d}_{h}:{i}')}.xlsx`</span><br><span class="line">            );</span><br><span class="line">        } catch (e) {</span><br><span class="line">            if (typeof console !== "undefined") console.log(e, wbout);</span><br><span class="line">        }</span><br><span class="line">        return wbout;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></tbody></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Vue中实现el-table导出xlsx文件下载&lt;/p&gt;</summary>
    
    
    
    <category term="Vue" scheme="https://codezm.github.io/categories/Vue/"/>
    
    
    <category term="Vue" scheme="https://codezm.github.io/tags/Vue/"/>
    
    <category term="xlsx" scheme="https://codezm.github.io/tags/xlsx/"/>
    
  </entry>
  
  <entry>
    <title>VSCode快捷键</title>
    <link href="https://codezm.github.io/posts/VSCode/kjj.html"/>
    <id>https://codezm.github.io/posts/VSCode/kjj.html</id>
    <published>2023-09-28T17:31:17.000Z</published>
    <updated>2025-12-01T08:02:38.311Z</updated>
    
    <content type="html"><![CDATA[<h1 id="VSCode快捷键"><a href="#VSCode快捷键" class="headerlink" title="VSCode快捷键"></a>VSCode快捷键</h1><table><thead><tr><th>功能<br>说明</th><th>MacOS快捷键</th><th>Windows快捷键</th></tr></thead><tbody><tr><td><u>核心导航（必会！）</u></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>快速打开文件<br>按下后输入文件名，快速跳转到任何文件，神器中的神器！</td><td>Cmd + P</td><td></td></tr><tr><td>命令面板<br>VSCode 的“魔法咒语”，所有功能都可以在这里搜索并执行。</td><td>Shift+Cmd+P</td><td><em>Ctrl</em>+<em>Shift</em>+<em>P</em></td></tr><tr><td>聚焦到资源管理器<br>如果侧边栏已打开，快速将焦点切换到文件资源管理器。</td><td>Cmd + Shift + E</td><td></td></tr><tr><td>在打开的文件之间切换<br>像浏览器标签一样切换最近使用的文件。</td><td>Ctrl + Tab</td><td></td></tr><tr><td>快速导航到符号（类、方法、变量等）</td><td>Shift+Cmd+O</td><td>Ctrl + Shift + O</td></tr><tr><td>显示/隐藏侧边栏<br>最大化编辑区域。</td><td>Cmd + B</td><td></td></tr><tr><td>显示/隐藏面板<br>切换下方面板（问题输出、调试控制台、终端等）的显示。</td><td>Cmd + J</td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td><u>编辑技巧（大幅提升编码速度）</u></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>多选相同词<br>选中一个单词后，按一次选中下一个相同的词，可以同时编辑多处。</td><td>Cmd + D</td><td>Ctrl + D</td></tr><tr><td>多光标编辑<br>在任意位置按住 <code>Option</code>并点击鼠标，可以添加多个光标，同时输入。</td><td>Option + 点击</td><td></td></tr><tr><td>向上/向下移动行<br>快速移动当前行或选中的多行代码。</td><td>Option + ↑/↓</td><td></td></tr><tr><td>向上/向下复制行<br>快速复制当前行或选中的多行代码。</td><td>Option + Shift + ↑/↓</td><td></td></tr><tr><td>删除行<br>无需选中，直接删除光标所在行。</td><td>Cmd + Shift + K</td><td></td></tr><tr><td>添加/移除行注释<br>注释或取消注释当前行或选中的多行。</td><td>Cmd + /</td><td></td></tr><tr><td>格式化文档<br>使用 Prettier 等格式化工具自动整理代码格式。</td><td>Option + Shift + F</td><td></td></tr><tr><td>下方插入行<br>无论光标在行中任何位置，直接跳到行尾并换行。</td><td>Cmd + Enter</td><td></td></tr><tr><td>切换自动换行<br>当代码行很长时，开启/关闭自动换行。</td><td>Option + Z</td><td></td></tr><tr><td>鼠标拖动竖向列选（当前光标处开始）</td><td>Option + Shift + 鼠标向上或向下拖动</td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td><u>搜索与替换（快速定位）</u></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>在文件中查找<br>当前文件内搜索。</td><td>Cmd + F</td><td></td></tr><tr><td>在文件中替换<br>当前文件内替换。</td><td>Option + Cmd + F</td><td></td></tr><tr><td>查找下一个/上一个<br>在查找模式下快速跳转。</td><td>Cmd + G<code>/ </code>Shift + Cmd + G</td><td></td></tr><tr><td>在全局中查找<br>在整个项目文件夹中搜索，功能非常强大。</td><td>Shift + Cmd + F</td><td>Ctrl + Shift + F</td></tr><tr><td>在全局中替换<br>在整个项目文件夹中搜索并替换。</td><td>Shift + Cmd + H</td><td>Ctrl + Shift + H</td></tr><tr><td></td><td></td><td></td></tr><tr><td><u>代码操作（理解与重构）</u></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>跳转到定义<br>跳转到变量、函数或类的定义处。</td><td>F12</td><td></td></tr><tr><td>查看定义<br>在不跳转的情况下，以小浮窗形式预览定义。</td><td>Option + F12</td><td></td></tr><tr><td>重命名符号<br>重命名变量、函数等，所有引用处会同步修改。</td><td>F2</td><td></td></tr><tr><td>后退<br>跳转到定义后，可以快速跳回原来的位置。</td><td>Ctrl + -</td><td></td></tr><tr><td>查看引用<br>显示所有引用该符号的地方。</td><td>Shift + F12</td><td></td></tr><tr><td>快速修复<br>当光标在有问题的代码上时，触发快速修复（如自动导入）。</td><td>Cmd + .</td><td>Ctrl + .</td></tr><tr><td>启动或继续调试</td><td>F5</td><td></td></tr><tr><td>停止调试</td><td>Shift + F5</td><td></td></tr><tr><td>重构<br>显示可用的重构选项（如提取函数、变量等）。</td><td>Shift + Option + F12</td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td><u>窗口与标签页管理</u></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td>拆分编辑器<br>向右拆分当前编辑器，实现分栏编辑。</td><td>Cmd + |</td><td></td></tr><tr><td>聚焦到第1/2/3个编辑组<br>在拆分后的多个编辑组之间快速切换焦点。</td><td>Cmd + 1/2/3</td><td></td></tr><tr><td>关闭当前标签页<br>关闭当前活动的编辑器。</td><td>Cmd + W</td><td></td></tr><tr><td>关闭所有标签页<br>先按 <code>Cmd + K</code>，松开后再按 <code>W</code>。</td><td>Cmd + K<code>then </code>W</td><td></td></tr><tr><td>在编辑器和终端间切换焦点<br>让光标在编辑器和集成终端之间快速切换。</td><td>Ctrl +`（Tab上方的键）</td><td></td></tr></tbody></table><a id="more"></a><h4 id="Bookmarks插件快捷键"><a href="#Bookmarks插件快捷键" class="headerlink" title="Bookmarks插件快捷键"></a>Bookmarks插件快捷键</h4><table><thead><tr><th>功能</th><th>MacOS快捷键</th><th>Windows快捷键</th></tr></thead><tbody><tr><td>创建或消除书签</td><td>Cmd+Option+K</td><td>Ctrl+alt+K</td></tr><tr><td>跳转到前一个书签</td><td>Cmd+Option+J</td><td>Ctrl+alt+J</td></tr><tr><td>跳转到后一个书签</td><td>Cmd+Option+L</td><td>Ctrl+alt+L</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;VSCode快捷键&quot;&gt;&lt;a href=&quot;#VSCode快捷键&quot; class=&quot;headerlink&quot; title=&quot;VSCode快捷键&quot;&gt;&lt;/a&gt;VSCode快捷键&lt;/h1&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;功能&lt;br&gt;说明&lt;/th&gt;
&lt;th&gt;MacOS快捷键&lt;/th&gt;
&lt;th&gt;Windows快捷键&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;&lt;u&gt;核心导航（必会！）&lt;/u&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;快速打开文件&lt;br&gt;按下后输入文件名，快速跳转到任何文件，神器中的神器！&lt;/td&gt;
&lt;td&gt;Cmd + P&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;命令面板&lt;br&gt;VSCode 的“魔法咒语”，所有功能都可以在这里搜索并执行。&lt;/td&gt;
&lt;td&gt;Shift+Cmd+P&lt;/td&gt;
&lt;td&gt;&lt;em&gt;Ctrl&lt;/em&gt;+&lt;em&gt;Shift&lt;/em&gt;+&lt;em&gt;P&lt;/em&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;聚焦到资源管理器&lt;br&gt;如果侧边栏已打开，快速将焦点切换到文件资源管理器。&lt;/td&gt;
&lt;td&gt;Cmd + Shift + E&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;在打开的文件之间切换&lt;br&gt;像浏览器标签一样切换最近使用的文件。&lt;/td&gt;
&lt;td&gt;Ctrl + Tab&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;快速导航到符号（类、方法、变量等）&lt;/td&gt;
&lt;td&gt;Shift+Cmd+O&lt;/td&gt;
&lt;td&gt;Ctrl + Shift + O&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;显示/隐藏侧边栏&lt;br&gt;最大化编辑区域。&lt;/td&gt;
&lt;td&gt;Cmd + B&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;显示/隐藏面板&lt;br&gt;切换下方面板（问题输出、调试控制台、终端等）的显示。&lt;/td&gt;
&lt;td&gt;Cmd + J&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;u&gt;编辑技巧（大幅提升编码速度）&lt;/u&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;多选相同词&lt;br&gt;选中一个单词后，按一次选中下一个相同的词，可以同时编辑多处。&lt;/td&gt;
&lt;td&gt;Cmd + D&lt;/td&gt;
&lt;td&gt;Ctrl + D&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;多光标编辑&lt;br&gt;在任意位置按住 &lt;code&gt;Option&lt;/code&gt;并点击鼠标，可以添加多个光标，同时输入。&lt;/td&gt;
&lt;td&gt;Option + 点击&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;向上/向下移动行&lt;br&gt;快速移动当前行或选中的多行代码。&lt;/td&gt;
&lt;td&gt;Option + ↑/↓&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;向上/向下复制行&lt;br&gt;快速复制当前行或选中的多行代码。&lt;/td&gt;
&lt;td&gt;Option + Shift + ↑/↓&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;删除行&lt;br&gt;无需选中，直接删除光标所在行。&lt;/td&gt;
&lt;td&gt;Cmd + Shift + K&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;添加/移除行注释&lt;br&gt;注释或取消注释当前行或选中的多行。&lt;/td&gt;
&lt;td&gt;Cmd + /&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;格式化文档&lt;br&gt;使用 Prettier 等格式化工具自动整理代码格式。&lt;/td&gt;
&lt;td&gt;Option + Shift + F&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;下方插入行&lt;br&gt;无论光标在行中任何位置，直接跳到行尾并换行。&lt;/td&gt;
&lt;td&gt;Cmd + Enter&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;切换自动换行&lt;br&gt;当代码行很长时，开启/关闭自动换行。&lt;/td&gt;
&lt;td&gt;Option + Z&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;鼠标拖动竖向列选（当前光标处开始）&lt;/td&gt;
&lt;td&gt;Option + Shift + 鼠标向上或向下拖动&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;u&gt;搜索与替换（快速定位）&lt;/u&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;在文件中查找&lt;br&gt;当前文件内搜索。&lt;/td&gt;
&lt;td&gt;Cmd + F&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;在文件中替换&lt;br&gt;当前文件内替换。&lt;/td&gt;
&lt;td&gt;Option + Cmd + F&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;查找下一个/上一个&lt;br&gt;在查找模式下快速跳转。&lt;/td&gt;
&lt;td&gt;Cmd + G&lt;code&gt;/ &lt;/code&gt;Shift + Cmd + G&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;在全局中查找&lt;br&gt;在整个项目文件夹中搜索，功能非常强大。&lt;/td&gt;
&lt;td&gt;Shift + Cmd + F&lt;/td&gt;
&lt;td&gt;Ctrl + Shift + F&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;在全局中替换&lt;br&gt;在整个项目文件夹中搜索并替换。&lt;/td&gt;
&lt;td&gt;Shift + Cmd + H&lt;/td&gt;
&lt;td&gt;Ctrl + Shift + H&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;u&gt;代码操作（理解与重构）&lt;/u&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;跳转到定义&lt;br&gt;跳转到变量、函数或类的定义处。&lt;/td&gt;
&lt;td&gt;F12&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;查看定义&lt;br&gt;在不跳转的情况下，以小浮窗形式预览定义。&lt;/td&gt;
&lt;td&gt;Option + F12&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;重命名符号&lt;br&gt;重命名变量、函数等，所有引用处会同步修改。&lt;/td&gt;
&lt;td&gt;F2&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;后退&lt;br&gt;跳转到定义后，可以快速跳回原来的位置。&lt;/td&gt;
&lt;td&gt;Ctrl + -&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;查看引用&lt;br&gt;显示所有引用该符号的地方。&lt;/td&gt;
&lt;td&gt;Shift + F12&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;快速修复&lt;br&gt;当光标在有问题的代码上时，触发快速修复（如自动导入）。&lt;/td&gt;
&lt;td&gt;Cmd + .&lt;/td&gt;
&lt;td&gt;Ctrl + .&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;启动或继续调试&lt;/td&gt;
&lt;td&gt;F5&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;停止调试&lt;/td&gt;
&lt;td&gt;Shift + F5&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;重构&lt;br&gt;显示可用的重构选项（如提取函数、变量等）。&lt;/td&gt;
&lt;td&gt;Shift + Option + F12&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;u&gt;窗口与标签页管理&lt;/u&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;拆分编辑器&lt;br&gt;向右拆分当前编辑器，实现分栏编辑。&lt;/td&gt;
&lt;td&gt;Cmd + |&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;聚焦到第1/2/3个编辑组&lt;br&gt;在拆分后的多个编辑组之间快速切换焦点。&lt;/td&gt;
&lt;td&gt;Cmd + 1/2/3&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;关闭当前标签页&lt;br&gt;关闭当前活动的编辑器。&lt;/td&gt;
&lt;td&gt;Cmd + W&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;关闭所有标签页&lt;br&gt;先按 &lt;code&gt;Cmd + K&lt;/code&gt;，松开后再按 &lt;code&gt;W&lt;/code&gt;。&lt;/td&gt;
&lt;td&gt;Cmd + K&lt;code&gt;then &lt;/code&gt;W&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;在编辑器和终端间切换焦点&lt;br&gt;让光标在编辑器和集成终端之间快速切换。&lt;/td&gt;
&lt;td&gt;Ctrl +`（Tab上方的键）&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;</summary>
    
    
    
    <category term="VSCode" scheme="https://codezm.github.io/categories/VSCode/"/>
    
    
    <category term="VSCode" scheme="https://codezm.github.io/tags/VSCode/"/>
    
  </entry>
  
  <entry>
    <title>项目中添加 jsconfig.json 文件</title>
    <link href="https://codezm.github.io/posts/Vue/5e5ddc84.html"/>
    <id>https://codezm.github.io/posts/Vue/5e5ddc84.html</id>
    <published>2023-09-28T17:31:17.000Z</published>
    <updated>2025-12-01T08:02:38.316Z</updated>
    
    <content type="html"><![CDATA[<p>项目中添加 jsconfig.json 文件，<code>jsconfig.json </code>的工作区中有一个定义项目上下文的文件时，JavaScript 体验会得到改善。</p><a id="more"></a><h2 id="文件代码示例"><a href="#文件代码示例" class="headerlink" title="文件代码示例"></a>文件代码示例</h2><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="attr">"allowJs"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"compilerOptions"</span>: {</span><br><span class="line">        <span class="attr">"baseUrl"</span>: <span class="string">"."</span>,</span><br><span class="line">        <span class="attr">"paths"</span>: {</span><br><span class="line">            <span class="attr">"@/*"</span>: [<span class="string">"./src/*"</span>]</span><br><span class="line">        }</span><br><span class="line">    },</span><br><span class="line">    <span class="attr">"include"</span>: [<span class="string">"src/**/*"</span>],</span><br><span class="line">    <span class="attr">"exclude"</span>: [<span class="string">"node_modules"</span>]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="文件作用"><a href="#文件作用" class="headerlink" title="文件作用"></a>文件作用</h2><p>目录中存在此类文件表明该目录是 JavaScript 项目的根目录。文件本身可以选择列出属于项目的文件、要从项目中排除的文件以及编译器选项。</p><p>当使用 <code>Visual Studio Code</code> 编辑器打开存在 <code>jsconfig.json</code> 文件的项目时，可以获得更好的上下文体验。</p><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul><li><a href="https://segmentfault.com/a/1190000041125740">jsconfig.json到底是做什么的</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;项目中添加 jsconfig.json 文件，&lt;code&gt;jsconfig.json &lt;/code&gt;的工作区中有一个定义项目上下文的文件时，JavaScript 体验会得到改善。&lt;/p&gt;</summary>
    
    
    
    <category term="Vue" scheme="https://codezm.github.io/categories/Vue/"/>
    
    
    <category term="前端" scheme="https://codezm.github.io/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="Vue" scheme="https://codezm.github.io/tags/Vue/"/>
    
  </entry>
  
</feed>
